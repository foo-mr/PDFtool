<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF大師 - 三分隔完整增強版 (v3.13 頁面組織版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#475569',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Noto Sans TC', system-ui, -apple-system, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .page-thumbnail.active { border: 3px solid #2563eb; transform: scale(0.98); }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .canvas-container { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        .custom-checkbox:checked { background-color: #2563eb; border-color: #2563eb; }

        /* Grid Editor Styles */
        .grid-page-item { transition: all 0.2s; }
        .grid-page-item:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .grid-page-item.selected { ring: 2px solid #2563eb; background-color: #eff6ff; }
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; border: 2px dashed #94a3b8; }
        .sortable-drag { cursor: grabbing; opacity: 1; background: white; transform: scale(1.05); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Top Header -->
    <header class="bg-white border-b border-gray-200 h-14 flex items-center justify-between px-6 shadow-sm z-10 flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-primary text-white p-1.5 rounded-lg">
                <i class="fa-solid fa-scissors"></i>
            </div>
            <h1 class="font-bold text-lg text-slate-700">PDF大師 <span class="text-xs font-normal text-gray-500 ml-2 border border-gray-200 px-2 py-0.5 rounded">v3.13 頁面組織版</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-xs text-gray-500 hidden md:block">
                <i class="fa-solid fa-shield-halved mr-1 text-success"></i> 本地安全處理 | 無需上傳
            </div>
            <button onclick="document.getElementById('fileInput').click()" class="bg-primary hover:bg-blue-700 text-white px-4 py-1.5 rounded-md text-sm transition flex items-center gap-2 shadow-sm">
                <i class="fa-solid fa-folder-open"></i> 開啟 PDF
            </button>
            <input type="file" id="fileInput" accept=".pdf" class="hidden" onchange="handleFileUpload(event)">
        </div>
    </header>

    <!-- Main Layout -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- Pane 1: Left Sidebar -->
        <aside class="w-64 bg-gray-50 border-r border-gray-200 flex flex-col flex-shrink-0 transition-all duration-300" id="leftPanel">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <span class="font-medium text-sm text-gray-600">頁面導覽</span>
                <span id="pageCountBadge" class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">0 頁</span>
            </div>
            <div id="thumbnailContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="text-center text-gray-400 mt-10 text-sm">
                    <i class="fa-regular fa-file-pdf text-4xl mb-3 opacity-50"></i>
                    <p>請開啟 PDF 文件</p>
                </div>
            </div>
        </aside>

        <!-- Pane 2: Center (Multi-View) -->
        <section class="flex-1 bg-gray-200 relative flex flex-col min-w-0">
            
            <!-- Toolbar -->
            <div class="h-10 bg-white border-b border-gray-200 flex items-center justify-between px-4 shadow-sm z-10">
                <!-- View Toggle -->
                <div class="flex gap-1 bg-gray-100 p-0.5 rounded">
                    <button onclick="switchView('preview')" id="btnViewPreview" class="px-3 py-0.5 text-xs font-medium rounded shadow-sm bg-white text-gray-800 transition">預覽模式</button>
                    <button onclick="switchView('grid')" id="btnViewGrid" class="px-3 py-0.5 text-xs font-medium rounded text-gray-500 hover:text-gray-800 transition">網格編輯</button>
                </div>

                <!-- Preview Controls -->
                <div id="previewControls" class="flex items-center gap-4">
                    <button onclick="changePage(-1)" class="text-gray-600 hover:text-primary disabled:opacity-30 transition" id="prevPageBtn" disabled>
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <span class="text-sm font-medium text-gray-700 w-24 text-center" id="pageIndicator">-- / --</span>
                    <button onclick="changePage(1)" class="text-gray-600 hover:text-primary disabled:opacity-30 transition" id="nextPageBtn" disabled>
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                    <div class="h-4 w-px bg-gray-300 mx-2"></div>
                    <button onclick="zoom(-0.2)" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-magnifying-glass-minus"></i></button>
                    <button onclick="zoom(0.2)" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
                </div>

                <!-- Grid Controls (Hidden by default) -->
                <div id="gridControls" class="hidden flex items-center gap-3 text-xs">
                    <span class="text-gray-500"><i class="fa-solid fa-hand-pointer mr-1"></i>拖曳以排序</span>
                    <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded" id="selectedCountBadge">已選 0</span>
                </div>
            </div>

            <!-- View 1: Single Page Canvas -->
            <div id="mainViewer" class="flex-1 overflow-auto flex justify-center p-8 relative">
                <div id="canvasWrapper" class="relative transition-transform duration-200 ease-out origin-top">
                    <canvas id="the-canvas" class="canvas-container bg-white"></canvas>
                    <div id="loadingOverlay" class="absolute inset-0 bg-white/80 flex items-center justify-center z-20 hidden">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                    </div>
                </div>
                
                <!-- Welcome State -->
                <div id="welcomeState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 z-0 pointer-events-none">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 text-center max-w-md mx-4">
                        <div class="w-16 h-16 bg-blue-50 text-primary rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-700 mb-2">準備開始</h3>
                        <p class="text-sm mb-4">支援 PDF 分割、提取、重組。所有操作均在您的設備上完成。</p>
                    </div>
                </div>
            </div>

            <!-- View 2: Grid Editor -->
            <div id="gridEditor" class="hidden flex-1 overflow-y-auto p-6 bg-gray-200">
                <div id="gridContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 pb-20">
                    <!-- Grid items injected here -->
                </div>
            </div>

        </section>

        <!-- Pane 3: Right Sidebar -->
        <aside class="w-80 bg-white border-l border-gray-200 flex flex-col flex-shrink-0 shadow-lg z-20" id="rightPanel">
            <!-- Tabs -->
            <div class="flex border-b border-gray-200">
                <button onclick="switchTab('split')" id="tabSplit" class="flex-1 py-3 text-sm font-medium text-primary border-b-2 border-primary bg-blue-50 transition">
                    <i class="fa-solid fa-layer-group mr-1"></i> 分割提取
                </button>
                <button onclick="switchTab('organize')" id="tabOrganize" class="flex-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-primary transition">
                    <i class="fa-solid fa-border-all mr-1"></i> 頁面管理
                </button>
            </div>

            <div class="flex-1 overflow-hidden relative">
                
                <!-- Tab Content: Split & Extract -->
                <div id="contentSplit" class="absolute inset-0 overflow-y-auto p-5 space-y-6 flex flex-col">
                    <!-- Range Selection -->
                    <div class="space-y-3">
                        <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">手動範圍設定</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">起始頁</label>
                                <input type="number" id="startPage" min="1" class="w-full border border-gray-300 rounded p-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">結束頁</label>
                                <input type="number" id="endPage" min="1" class="w-full border border-gray-300 rounded p-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                            </div>
                        </div>
                        <button onclick="addRange()" class="w-full bg-secondary hover:bg-slate-600 text-white py-2 rounded text-sm transition">
                            <i class="fa-solid fa-plus mr-1"></i> 加入提取清單
                        </button>
                    </div>

                    <hr class="border-gray-100">

                    <!-- Auto Detect -->
                    <div class="space-y-3">
                        <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">智能化工具</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="autoDetectChapters()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 py-2 rounded text-xs transition flex flex-col items-center justify-center gap-1 h-16">
                                <i class="fa-solid fa-wand-magic-sparkles text-primary text-lg"></i>
                                智能章節
                            </button>
                            <button onclick="splitEveryNPages()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 py-2 rounded text-xs transition flex flex-col items-center justify-center gap-1 h-16">
                                <i class="fa-solid fa-table-columns text-primary text-lg"></i>
                                定量分割
                            </button>
                        </div>
                    </div>

                    <hr class="border-gray-100">

                    <!-- Range List -->
                    <div class="flex-1 min-h-[150px] flex flex-col">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-sm font-bold text-gray-700">待處理清單</h3>
                            <div class="flex gap-2">
                                <button id="mergeBtn" onclick="openMergePreview()" disabled class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded border border-indigo-200 hover:bg-indigo-100 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-1">
                                    <i class="fa-solid fa-link"></i> 合併選取
                                </button>
                                <button onclick="clearRanges()" class="text-xs text-red-500 hover:text-red-700 px-1 py-1">清空</button>
                            </div>
                        </div>
                        <div id="rangeList" class="space-y-2 flex-1 overflow-y-auto">
                            <div class="text-center text-gray-400 text-xs py-8 border-2 border-dashed border-gray-200 rounded">尚未加入任何範圍</div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Organize Pages -->
                <div id="contentOrganize" class="absolute inset-0 overflow-y-auto p-5 space-y-6 hidden bg-gray-50">
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 bg-orange-100 text-warning rounded-full flex items-center justify-center mx-auto mb-2 text-xl">
                            <i class="fa-solid fa-sort"></i>
                        </div>
                        <h3 class="text-gray-800 font-bold">頁面重組工具</h3>
                        <p class="text-xs text-gray-500 mt-1">在網格中拖曳頁面以重新排序</p>
                    </div>

                    <div class="bg-white rounded-lg border border-gray-200 p-4 shadow-sm space-y-3">
                        <h4 class="text-xs font-bold text-gray-400 uppercase">選取操作</h4>
                        
                        <button onclick="copySelectedPages()" class="w-full flex items-center justify-between bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2 rounded text-sm transition group">
                            <span><i class="fa-regular fa-copy mr-2 text-blue-500"></i>複製選取頁面</span>
                            <span class="text-xs bg-gray-100 text-gray-500 px-1.5 rounded group-hover:bg-gray-200" id="copyCountBadge">0</span>
                        </button>

                        <button onclick="pastePages()" class="w-full flex items-center justify-between bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-2 rounded text-sm transition disabled:opacity-50" id="btnPaste" disabled>
                            <span><i class="fa-regular fa-paste mr-2 text-green-500"></i>貼上頁面</span>
                            <span class="text-xs bg-gray-100 text-gray-500 px-1.5 rounded" id="clipboardBadge">0</span>
                        </button>

                        <button onclick="deleteSelectedPages()" class="w-full flex items-center justify-between bg-white border border-red-200 hover:bg-red-50 text-red-600 px-3 py-2 rounded text-sm transition">
                            <span><i class="fa-solid fa-trash mr-2"></i>刪除選取頁面</span>
                        </button>
                    </div>

                    <div class="bg-blue-50 border border-blue-100 rounded p-3">
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-circle-info text-blue-500 mt-0.5 text-xs"></i>
                            <div class="text-xs text-blue-800">
                                <p class="mb-1 font-bold">提示：</p>
                                <ul class="list-disc list-inside space-y-1 opacity-80">
                                    <li>按住 Ctrl/Cmd 可多選</li>
                                    <li>貼上時會插在最後選取的頁面後方</li>
                                    <li>所有變更將在下載時生效</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <button onclick="resetPageOrder()" class="w-full text-xs text-gray-400 hover:text-gray-600 underline mt-4">
                        重置為原始順序
                    </button>
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="p-4 border-t border-gray-200 bg-gray-50 space-y-3 z-20 relative">
                <div>
                    <label class="text-xs text-gray-500 mb-1 block">輸出格式</label>
                    <select id="outputFormat" class="w-full border border-gray-300 rounded p-2 text-sm bg-white focus:border-primary outline-none">
                        <option value="pdf_split">獨立 PDF 文件 (ZIP)</option>
                        <option value="pdf_merge">合併為一個新 PDF</option>
                        <option value="images">圖片序列 (JPG/ZIP)</option>
                        <option value="text">純文字提取 (TXT)</option>
                    </select>
                </div>
                <button id="processBtn" onclick="processAndDownload()" disabled class="w-full bg-primary hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-medium py-2.5 rounded shadow-lg shadow-blue-500/30 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-download"></i> 開始處理與下載
                </button>
            </div>
        </aside>
    </main>

    <!-- Modals & Overlays -->
    <div id="progressModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="font-bold text-lg mb-2 text-gray-800" id="progressTitle">處理中...</h3>
            <p class="text-sm text-gray-500 mb-4" id="progressDesc">請稍候。</p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                <div id="progressBar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="text-right text-xs text-gray-500" id="progressText">0%</div>
        </div>
    </div>
    
    <!-- Merge Preview Modal -->
    <div id="mergeModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-0 w-full max-w-md overflow-hidden">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-object-group mr-2"></i>合併章節預覽</h3>
                <button onclick="closeMergeModal()" class="text-indigo-200 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <p class="text-sm text-gray-500 mb-3">合併 <span id="mergeCount" class="font-bold text-indigo-600">0</span> 個選取範圍：</p>
                <ul id="mergeListPreview" class="bg-gray-50 rounded border border-gray-200 text-sm text-gray-600 divide-y divide-gray-200 mb-4"></ul>
                <div class="bg-indigo-50 border border-indigo-100 rounded p-4 text-center">
                    <p class="text-xs text-indigo-500 font-bold">合併結果</p>
                    <p class="text-lg font-bold text-indigo-700" id="mergeResultRange">--</p>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeMergeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded text-sm">取消</button>
                <button onclick="confirmMerge()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-sm font-medium">確認合併</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded shadow-lg opacity-0 pointer-events-none z-50 text-sm transition-opacity duration-300"></div>

    <script>
        // --- Global State ---
        let pdfDoc = null;
        let pdfBytes = null;
        let pageNum = 1;
        let scale = 1.0;
        let canvas = document.getElementById('the-canvas');
        let ctx = canvas.getContext('2d');
        let fileName = "document";
        
        // Data Models
        let ranges = []; // {start, end, id}
        let selectedRangeIds = new Set();
        
        // Page Organization State
        // pageSequence stores objects: { originalPage: 1, id: 'uuid-...' }
        let pageSequence = []; 
        let selectedPageIds = new Set(); // IDs of selected pages in grid
        let clipboardPages = []; // Array of { originalPage }
        let sortableInstance = null;

        // --- Initialization ---
        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded shadow-lg transition-opacity duration-300 z-50 text-sm ${type === 'error' ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }

        function updateUIState() {
            const totalPages = pageSequence.length;
            const hasDoc = !!pdfDoc;

            // Nav Buttons
            document.getElementById('prevPageBtn').disabled = pageNum <= 1;
            document.getElementById('nextPageBtn').disabled = !hasDoc || pageNum >= totalPages;
            document.getElementById('processBtn').disabled = !hasDoc; // Allow download if Doc exists (even if no split ranges, implies "download as is/reorganized")
            
            // Text Updates
            if (hasDoc) {
                document.getElementById('pageIndicator').innerText = `${pageNum} / ${totalPages}`;
                document.getElementById('pageCountBadge').innerText = `${totalPages} 頁`;
                document.getElementById('welcomeState').classList.add('hidden');
                
                // Sync inputs
                document.getElementById('startPage').max = totalPages;
                document.getElementById('endPage').max = totalPages;
            }

            // Merge Button
            const mergeBtn = document.getElementById('mergeBtn');
            mergeBtn.disabled = selectedRangeIds.size < 2;
            mergeBtn.innerHTML = selectedRangeIds.size > 0 
                ? `<i class="fa-solid fa-link"></i> 合併 (${selectedRangeIds.size})`
                : `<i class="fa-solid fa-link"></i> 合併選取`;

            // Grid Selection UI
            document.getElementById('selectedCountBadge').innerText = `已選 ${selectedPageIds.size}`;
            document.getElementById('copyCountBadge').innerText = selectedPageIds.size;
            document.getElementById('btnPaste').disabled = clipboardPages.length === 0;
            document.getElementById('clipboardBadge').innerText = clipboardPages.length;
        }

        // --- View Switching ---
        function switchView(mode) {
            const viewer = document.getElementById('mainViewer');
            const grid = document.getElementById('gridEditor');
            const pControls = document.getElementById('previewControls');
            const gControls = document.getElementById('gridControls');
            const btnPreview = document.getElementById('btnViewPreview');
            const btnGrid = document.getElementById('btnViewGrid');

            if (mode === 'preview') {
                viewer.classList.remove('hidden');
                grid.classList.add('hidden');
                pControls.classList.remove('hidden');
                gControls.classList.add('hidden');
                btnPreview.className = "px-3 py-0.5 text-xs font-medium rounded shadow-sm bg-white text-gray-800 transition";
                btnGrid.className = "px-3 py-0.5 text-xs font-medium rounded text-gray-500 hover:text-gray-800 transition";
                // Sync position
                renderPage(pageNum);
            } else {
                viewer.classList.add('hidden');
                grid.classList.remove('hidden');
                pControls.classList.add('hidden');
                gControls.classList.remove('hidden');
                btnPreview.className = "px-3 py-0.5 text-xs font-medium rounded text-gray-500 hover:text-gray-800 transition";
                btnGrid.className = "px-3 py-0.5 text-xs font-medium rounded shadow-sm bg-white text-gray-800 transition";
                // Render grid
                renderGridEditor();
            }
        }

        function switchTab(tab) {
            const contentSplit = document.getElementById('contentSplit');
            const contentOrganize = document.getElementById('contentOrganize');
            const tabSplit = document.getElementById('tabSplit');
            const tabOrganize = document.getElementById('tabOrganize');

            if (tab === 'split') {
                contentSplit.classList.remove('hidden');
                contentOrganize.classList.add('hidden');
                tabSplit.className = "flex-1 py-3 text-sm font-medium text-primary border-b-2 border-primary bg-blue-50 transition";
                tabOrganize.className = "flex-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-primary transition";
            } else {
                contentSplit.classList.add('hidden');
                contentOrganize.classList.remove('hidden');
                tabSplit.className = "flex-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-primary transition";
                tabOrganize.className = "flex-1 py-3 text-sm font-medium text-primary border-b-2 border-primary bg-blue-50 transition";
                // Auto switch to grid view when organizing
                switchView('grid');
            }
        }

        // --- File Handling ---
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('progressModal').classList.remove('hidden');
            updateProgress(10, '正在讀取文件...');
            fileName = file.name.replace('.pdf', '');

            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfBytes = arrayBuffer;
                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                pdfDoc = await loadingTask.promise;

                // Initialize Sequence
                pageSequence = [];
                for(let i=1; i<=pdfDoc.numPages; i++) {
                    pageSequence.push({ originalPage: i, id: crypto.randomUUID() });
                }

                updateProgress(50, '生成預覽...');
                pageNum = 1;
                ranges = [];
                selectedRangeIds.clear();
                selectedPageIds.clear();
                clipboardPages = [];
                
                renderRangeList();
                await renderPage(pageNum);
                await generateThumbnails();

                updateProgress(100, '完成');
                setTimeout(() => document.getElementById('progressModal').classList.add('hidden'), 500);
                updateUIState();
                showToast(`已載入 ${pdfDoc.numPages} 頁`);

            } catch (error) {
                console.error(error);
                document.getElementById('progressModal').classList.add('hidden');
                showToast('無法讀取 PDF', 'error');
            }
        }

        // --- Rendering Core (Virtual Mapped) ---
        function getOriginalPageNum(logicalNum) {
            if (!pageSequence[logicalNum - 1]) return 1;
            return pageSequence[logicalNum - 1].originalPage;
        }

        async function renderPage(num) {
            if(!pdfDoc || num < 1 || num > pageSequence.length) return;
            
            // Map logical page "num" to original page index
            const originalNum = getOriginalPageNum(num);

            const page = await pdfDoc.getPage(originalNum);
            const viewport = page.getViewport({ scale: scale * 1.5 });
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            canvas.style.width = `${viewport.width / 1.5}px`;
            canvas.style.height = `${viewport.height / 1.5}px`;

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            
            // Highlight thumbnail
            document.querySelectorAll('.page-thumbnail').forEach(el => el.classList.remove('active'));
            const currentThumb = document.getElementById(`thumb-${num}`);
            if (currentThumb) {
                currentThumb.classList.add('active');
                currentThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            updateUIState();
        }

        function changePage(offset) {
            const newPage = pageNum + offset;
            if (newPage >= 1 && newPage <= pageSequence.length) {
                pageNum = newPage;
                renderPage(pageNum);
                document.getElementById('startPage').value = pageNum;
                document.getElementById('endPage').value = pageNum;
            }
        }

        function zoom(delta) {
            scale += delta;
            if (scale < 0.4) scale = 0.4;
            if (scale > 3.0) scale = 3.0;
            renderPage(pageNum);
        }

        // --- Thumbnails ---
        async function generateThumbnails() {
            const container = document.getElementById('thumbnailContainer');
            container.innerHTML = '';
            
            // Render based on sequence
            for (let i = 0; i < pageSequence.length; i++) {
                const logicalNum = i + 1;
                const originalNum = pageSequence[i].originalPage;
                
                const div = document.createElement('div');
                div.className = 'page-thumbnail bg-white p-1 rounded border border-gray-200 cursor-pointer hover:shadow-md transition relative';
                div.id = `thumb-${logicalNum}`;
                div.onclick = () => { pageNum = logicalNum; renderPage(pageNum); };
                
                // Create canvas placeholder
                div.innerHTML = `
                    <div class="h-32 bg-gray-100 mb-1 flex items-center justify-center relative overflow-hidden page-thumb-canvas-wrapper">
                         <span class="text-xs text-gray-400">Loading...</span>
                    </div>
                    <div class="text-center text-xs font-medium text-gray-500 flex justify-between px-1">
                        <span>Page ${logicalNum}</span>
                        <span class="text-[10px] text-gray-300">#${originalNum}</span>
                    </div>
                `;
                container.appendChild(div);

                // Lazy render first few
                if (i < 10) renderSmallCanvas(originalNum, div.querySelector('.page-thumb-canvas-wrapper'));
            }
        }

        async function renderSmallCanvas(originalNum, container) {
            try {
                const page = await pdfDoc.getPage(originalNum);
                const viewport = page.getViewport({ scale: 0.2 });
                const cvs = document.createElement('canvas');
                cvs.height = viewport.height;
                cvs.width = viewport.width;
                cvs.className = "w-full h-full object-contain";
                await page.render({ canvasContext: cvs.getContext('2d'), viewport: viewport }).promise;
                container.innerHTML = '';
                container.appendChild(cvs);
            } catch(e) {}
        }

        // --- GRID EDITOR (New Feature) ---
        function renderGridEditor() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';

            pageSequence.forEach((pageObj, index) => {
                const logicalNum = index + 1;
                const isSelected = selectedPageIds.has(pageObj.id);
                
                const div = document.createElement('div');
                div.className = `grid-page-item bg-white rounded-lg p-2 border cursor-pointer relative group ${isSelected ? 'selected border-blue-500' : 'border-gray-200 hover:border-blue-300'}`;
                div.dataset.id = pageObj.id;
                div.dataset.index = index;
                div.onclick = (e) => toggleGridSelection(pageObj.id, e.ctrlKey || e.metaKey);

                div.innerHTML = `
                    <div class="aspect-[1/1.4] bg-gray-100 rounded overflow-hidden relative mb-2 flex items-center justify-center grid-canvas-wrapper">
                        <span class="text-xs text-gray-400">渲染中...</span>
                        <div class="absolute top-2 left-2 w-5 h-5 rounded-full border-2 ${isSelected ? 'bg-blue-500 border-blue-500' : 'bg-white/80 border-gray-300'} flex items-center justify-center transition-colors">
                            ${isSelected ? '<i class="fa-solid fa-check text-white text-[10px]"></i>' : ''}
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-600 px-1">
                        <span class="font-bold">第 ${logicalNum} 頁</span>
                        <span class="text-gray-300 text-[10px]">源:${pageObj.originalPage}</span>
                    </div>
                `;
                container.appendChild(div);
                
                // Render canvas async
                renderSmallCanvas(pageObj.originalPage, div.querySelector('.grid-canvas-wrapper'));
            });

            // Init Sortable
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(container, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function (evt) {
                    // Update Array Order
                    const item = pageSequence.splice(evt.oldIndex, 1)[0];
                    pageSequence.splice(evt.newIndex, 0, item);
                    
                    // Re-render thumbnails and counters (but maybe not grid to prevent flicker)
                    renderGridEditor(); // Full re-render to update page numbers
                    generateThumbnails();
                    renderPage(pageNum);
                }
            });
        }

        function toggleGridSelection(id, multiSelect) {
            if (!multiSelect) {
                selectedPageIds.clear();
            }
            
            if (selectedPageIds.has(id)) {
                selectedPageIds.delete(id);
            } else {
                selectedPageIds.add(id);
            }
            renderGridEditor();
            updateUIState();
        }

        // --- Copy / Paste / Delete ---
        function copySelectedPages() {
            if (selectedPageIds.size === 0) return;
            // Filter sequence to keep order
            clipboardPages = pageSequence
                .filter(p => selectedPageIds.has(p.id))
                .map(p => ({ originalPage: p.originalPage })); // Copy structure only
            
            showToast(`已複製 ${clipboardPages.length} 頁`, 'success');
            updateUIState();
        }

        function pastePages() {
            if (clipboardPages.length === 0) return;
            
            // Find insert position (after last selected, or end)
            let insertIndex = pageSequence.length;
            if (selectedPageIds.size > 0) {
                // Find the highest index of selected pages
                let maxIdx = -1;
                pageSequence.forEach((p, idx) => {
                    if (selectedPageIds.has(p.id)) maxIdx = idx;
                });
                if (maxIdx !== -1) insertIndex = maxIdx + 1;
            }

            // Generate new items with unique IDs
            const newItems = clipboardPages.map(p => ({
                originalPage: p.originalPage,
                id: crypto.randomUUID()
            }));

            // Insert
            pageSequence.splice(insertIndex, 0, ...newItems);
            
            // Clear selection and select newly pasted
            selectedPageIds.clear();
            newItems.forEach(p => selectedPageIds.add(p.id));
            
            // Refresh
            renderGridEditor();
            generateThumbnails();
            updateUIState();
            showToast(`已貼上 ${newItems.length} 頁`);
        }

        function deleteSelectedPages() {
            if (selectedPageIds.size === 0) return;
            
            const initialLen = pageSequence.length;
            pageSequence = pageSequence.filter(p => !selectedPageIds.has(p.id));
            
            if (pageSequence.length === 0) {
                // Prevent empty doc
                showToast('無法刪除所有頁面', 'error');
                // Restore (could improve undo logic later)
                // For now, simple reload logic or just alert
                if (confirm("文件不能為空。是否重置？")) resetPageOrder();
                return;
            }

            selectedPageIds.clear();
            renderGridEditor();
            generateThumbnails();
            // Reset view to page 1 if current page deleted
            pageNum = 1;
            renderPage(1);
            updateUIState();
            showToast(`已刪除 ${initialLen - pageSequence.length} 頁`);
        }

        function resetPageOrder() {
            if (!pdfDoc) return;
            pageSequence = [];
            for(let i=1; i<=pdfDoc.numPages; i++) {
                pageSequence.push({ originalPage: i, id: crypto.randomUUID() });
            }
            selectedPageIds.clear();
            clipboardPages = [];
            renderGridEditor();
            generateThumbnails();
            renderPage(1);
            showToast('已重置為原始順序');
        }

        // --- Logic: Range Management (Existing) ---
        function addRange() {
            if (!pdfDoc) return;
            const start = parseInt(document.getElementById('startPage').value);
            const end = parseInt(document.getElementById('endPage').value);
            const max = pageSequence.length;

            if (!start || !end || start > end || start < 1 || end > max) {
                showToast('請輸入有效的頁碼範圍', 'error');
                return;
            }
            ranges.push({ id: Date.now(), start, end });
            renderRangeList();
        }

        function removeRange(id) {
            ranges = ranges.filter(r => r.id !== id);
            selectedRangeIds.delete(id);
            renderRangeList();
        }

        function clearRanges() {
            ranges = [];
            selectedRangeIds.clear();
            renderRangeList();
        }

        function toggleRangeSelection(id) {
            if (selectedRangeIds.has(id)) selectedRangeIds.delete(id);
            else selectedRangeIds.add(id);
            renderRangeList(false);
        }

        function renderRangeList(scroll = true) {
            const container = document.getElementById('rangeList');
            container.innerHTML = '';
            if (ranges.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-xs py-8 border-2 border-dashed border-gray-200 rounded">尚未加入任何範圍</div>';
            } else {
                ranges.forEach((r, index) => {
                    const isSelected = selectedRangeIds.has(r.id);
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-2 rounded border text-sm group cursor-pointer transition-all select-none ${isSelected ? 'bg-indigo-50 border-indigo-300 ring-1 ring-indigo-300' : 'bg-white border-gray-200 hover:bg-gray-50'}`;
                    div.onclick = (e) => { if (!e.target.closest('button')) toggleRangeSelection(r.id); };
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" class="w-4 h-4 custom-checkbox rounded" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleRangeSelection(${r.id})">
                            <span class="${isSelected ? 'bg-indigo-200 text-indigo-700' : 'bg-blue-100 text-blue-700'} text-xs font-bold px-2 py-0.5 rounded">#${index + 1}</span>
                            <span class="text-gray-700 font-medium">第 ${r.start} - ${r.end} 頁</span>
                        </div>
                        <button onclick="event.stopPropagation(); removeRange(${r.id})" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition px-2"><i class="fa-solid fa-trash"></i></button>
                    `;
                    container.appendChild(div);
                });
                if (scroll) container.scrollTop = container.scrollHeight;
            }
            updateUIState();
        }

        // --- Logic: Auto Detect ---
        function autoDetectChapters() {
            if (!pdfDoc) return;
            // Simulation
            ranges = [];
            const total = pageSequence.length;
            let cursor = 1;
            while(cursor <= total) {
                let next = Math.min(cursor + 4, total);
                ranges.push({ id: Date.now() + cursor, start: cursor, end: next });
                cursor = next + 1;
            }
            renderRangeList();
            showToast(`已自動檢測出 ${ranges.length} 個章節`);
        }

        function splitEveryNPages() {
            const n = prompt("每多少頁分割為一個文件？", "1");
            if (!n || isNaN(n) || n < 1) return;
            ranges = [];
            const total = pageSequence.length;
            const perPage = parseInt(n);
            for (let i = 1; i <= total; i += perPage) {
                ranges.push({
                    id: Date.now() + i,
                    start: i,
                    end: Math.min(i + perPage - 1, total)
                });
            }
            renderRangeList();
        }

        // --- Logic: Merge ---
        function openMergePreview() {
            const selectedItems = ranges.filter(r => selectedRangeIds.has(r.id)).sort((a, b) => a.start - b.start);
            if (selectedItems.length < 2) return;

            const list = document.getElementById('mergeListPreview');
            list.innerHTML = '';
            selectedItems.forEach(item => {
                list.innerHTML += `<li class="px-4 py-2 flex justify-between"><span>第 ${item.start}-${item.end} 頁</span></li>`;
            });
            document.getElementById('mergeCount').innerText = selectedItems.length;
            
            const newStart = Math.min(...selectedItems.map(i => i.start));
            const newEnd = Math.max(...selectedItems.map(i => i.end));
            document.getElementById('mergeResultRange').innerText = `第 ${newStart} - ${newEnd} 頁`;
            document.getElementById('mergeModal').classList.remove('hidden');
        }

        function closeMergeModal() { document.getElementById('mergeModal').classList.add('hidden'); }

        function confirmMerge() {
            const selectedItems = ranges.filter(r => selectedRangeIds.has(r.id));
            const newStart = Math.min(...selectedItems.map(i => i.start));
            const newEnd = Math.max(...selectedItems.map(i => i.end));
            ranges = ranges.filter(r => !selectedRangeIds.has(r.id));
            ranges.push({ id: Date.now(), start: newStart, end: newEnd });
            ranges.sort((a, b) => a.start - b.start);
            selectedRangeIds.clear();
            closeMergeModal();
            renderRangeList();
            showToast('合併成功', 'success');
        }

        // --- Process & Download (UPDATED FOR MAPPING) ---
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').innerText = `${percent}%`;
            if (text) document.getElementById('progressDesc').innerText = text;
        }

        async function processAndDownload() {
            const format = document.getElementById('outputFormat').value;
            const modal = document.getElementById('progressModal');
            modal.classList.remove('hidden');
            
            try {
                const zip = new JSZip();
                const { PDFDocument } = PDFLib;
                updateProgress(10, '載入原始文件...');
                const srcDoc = await PDFDocument.load(pdfBytes);

                // Helper: Get source indices (0-based) from logical range
                const getIndices = (start, end) => {
                    const indices = [];
                    // Loop logical range
                    for (let i = start; i <= end; i++) {
                        // Get original page number from sequence (1-based)
                        const origPage = pageSequence[i-1].originalPage;
                        indices.push(origPage - 1); // Convert to 0-based for pdf-lib
                    }
                    return indices;
                };

                // Default: If no ranges, process WHOLE document (useful for just reorganization)
                const processRanges = ranges.length > 0 ? ranges : [{start: 1, end: pageSequence.length}];

                if (format === 'pdf_split') {
                    for (let i = 0; i < processRanges.length; i++) {
                        const range = processRanges[i];
                        updateProgress(10 + (i / processRanges.length * 80), `處理文件 ${i+1}...`);
                        
                        const subDoc = await PDFDocument.create();
                        const indices = getIndices(range.start, range.end);
                        const copiedPages = await subDoc.copyPages(srcDoc, indices);
                        copiedPages.forEach(page => subDoc.addPage(page));
                        
                        const data = await subDoc.save();
                        zip.file(`${fileName}_part_${i+1}.pdf`, data);
                    }
                    updateProgress(95, '打包中...');
                    const content = await zip.generateAsync({ type: "blob" });
                    downloadBlob(content, `${fileName}_split.zip`);
                } 
                else if (format === 'pdf_merge') {
                    updateProgress(30, '合併頁面...');
                    const newDoc = await PDFDocument.create();
                    
                    // Collect all indices in order
                    let allIndices = [];
                    processRanges.forEach(r => {
                        allIndices.push(...getIndices(r.start, r.end));
                    });

                    // Note: If simply reorganizing and downloading "Whole Doc", ranges logic handles it if we defaulted above
                    
                    const copiedPages = await newDoc.copyPages(srcDoc, allIndices);
                    copiedPages.forEach(page => newDoc.addPage(page));
                    
                    const data = await newDoc.save();
                    downloadBlob(new Blob([data], {type: 'application/pdf'}), `${fileName}_reorganized.pdf`);
                }
                else if (format === 'images') {
                    let processed = 0;
                    const totalItems = processRanges.reduce((acc, r) => acc + (r.end - r.start + 1), 0);

                    for (let r of processRanges) {
                        for (let p = r.start; p <= r.end; p++) {
                            processed++;
                            updateProgress(10 + (processed / totalItems * 80), `Rendering page ${p}...`);
                            
                            const origPageNum = getOriginalPageNum(p);
                            const page = await pdfDoc.getPage(origPageNum);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const cvs = document.createElement('canvas');
                            cvs.width = viewport.width;
                            cvs.height = viewport.height;
                            await page.render({ canvasContext: cvs.getContext('2d'), viewport: viewport }).promise;
                            
                            const imgData = cvs.toDataURL('image/jpeg', 0.85).split(',')[1];
                            zip.file(`${fileName}_page_${p}.jpg`, imgData, {base64: true});
                        }
                    }
                    const content = await zip.generateAsync({ type: "blob" });
                    downloadBlob(content, `${fileName}_images.zip`);
                }
                else if (format === 'text') {
                    let fullText = "";
                    let processed = 0;
                    const totalItems = processRanges.reduce((acc, r) => acc + (r.end - r.start + 1), 0);

                    for (let r of processRanges) {
                        for (let p = r.start; p <= r.end; p++) {
                            processed++;
                            updateProgress(10 + (processed / totalItems * 80), `Extracting page ${p}...`);
                            
                            const origPageNum = getOriginalPageNum(p);
                            const page = await pdfDoc.getPage(origPageNum);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += `--- Page ${p} (Source: ${origPageNum}) ---\n${pageText}\n\n`;
                        }
                    }
                    downloadBlob(new Blob([fullText], {type: 'text/plain'}), `${fileName}_text.txt`);
                }

                updateProgress(100, '完成！');
                setTimeout(() => modal.classList.add('hidden'), 1000);
            } catch (e) {
                console.error(e);
                showToast('處理失敗', 'error');
                modal.classList.add('hidden');
            }
        }

        function downloadBlob(blob, name) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>
