<!DOCTYPE html>
<html lang="zh-TW" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Organizer Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                extend: {
                    colors: {
                        brand: '#6366f1', brandHover: '#4f46e5',
                        surface: '#f8fafc', darkSurface: '#0f172a', darkCard: '#1e293b'
                    }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .page-card { 
            transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.15s ease-out, opacity 0.15s ease-out, filter 0.15s ease-out; 
            will-change: transform, filter;
            transform-origin: center;
            backface-visibility: hidden; 
        }
        .page-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15); }
        .page-card.selected { ring: 2px solid #6366f1; transform: scale(1.02); z-index: 10; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        
        .loader { border-top-color: #6366f1; animation: spinner 0.8s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Toolbar Animation */
        .toolbar-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        #dropOverlay { backdrop-filter: blur(8px); transition: opacity 0.2s ease-in-out; }
        
        .filename-input { background: transparent; border: 1px solid transparent; border-radius: 4px; padding: 2px 6px; transition: all 0.2s; }
        .filename-input:hover { background-color: rgba(0,0,0,0.05); }
        .dark .filename-input:hover { background-color: rgba(255,255,255,0.1); }
        .filename-input:focus { border-color: #6366f1; background-color: white; color: #0f172a; outline: none; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        
        /* Redesigned Grid Zoom Styles */
        :root {
            --col-count: 3;
            --zoom-track-height: 4px;
            --zoom-thumb-size: 16px;
        }
        
        /* ✅ FIXED: Grid Zoom Container - Viewport Safe */
        .grid-zoom-container {
            display: grid;
            grid-template-columns: repeat(var(--col-count), 1fr);
            gap: 24px;
            width: 100%;
            max-width: calc(100vw - 2rem);
            margin: 0 auto;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 1rem;
            box-sizing: border-box;
        }
        
        .grid-zoom-container[data-columns="1"] {
            max-width: calc(100vw - 2rem);
            gap: 32px;
        }
        
        .grid-zoom-container[data-columns="2"] {
            max-width: calc(100vw - 2rem);
            gap: 28px;
        }
        
        .grid-zoom-container[data-columns="3"],
        .grid-zoom-container[data-columns="4"],
        .grid-zoom-container[data-columns="5"] {
            width: 100%;
            max-width: calc(100vw - 2rem);
            gap: 24px;
        }
        
        /* Responsive gap scaling */
        @media (max-width: 768px) {
            .grid-zoom-container {
                padding: 0.5rem;
            }
            .grid-zoom-container[data-columns="4"],
            .grid-zoom-container[data-columns="5"] {
                gap: 16px;
            }
        }
        
        /* Zoom Controls */
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            dark:bg:rgba(30, 30, 30, 0.8);
            dark:border:rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .zoom-icon { color: #64748b; font-size: 0.875rem; transition: all 0.2s ease; }
        .dark .zoom-icon { color: #94a3b8; }
        .zoom-icon.active { color: #6366f1; transform: scale(1.1); }
        .dark .zoom-icon.active { color: #6366f1; }

        .slider-container { position: relative; width: 140px; display: flex; align-items: center; }
        
        .slider-background {
            position: absolute; top: 50%; left: 0; right: 0; transform: translateY(-50%);
            height: var(--zoom-track-height);
            background: #cbd5e1;
            border-radius: var(--zoom-track-height);
            z-index: 1;
        }
        .dark .slider-background { background: #475569; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; z-index: 2; position: relative; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: var(--zoom-track-height); background: transparent; border-radius: var(--zoom-track-height); }
        input[type=range]::-webkit-slider-thumb {
            height: var(--zoom-thumb-size); width: var(--zoom-thumb-size); border-radius: 50%; background: #6366f1;
            cursor: pointer; -webkit-appearance: none;
            margin-top: calc(-1 * var(--zoom-track-height) / 2 - var(--zoom-thumb-size) / 2 + 2px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3), 0 1px 3px rgba(99, 102, 241, 0.2);
            transition: all 0.2s ease; border: 2px solid white;
        }
        input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.1); }
        
        .zoom-label { min-width: 70px; text-align: center; font-variant-numeric: tabular-nums; font-size: 0.75rem; font-weight: 600; color: #64748b; transition: all 0.2s ease; }
        .dark .zoom-label { color: #94a3b8; }
        .zoom-label.active { color: #6366f1; font-weight: 700; }
        .dark .zoom-label.active { color: #6366f1; }

        /* ✅ ENHANCED Page Card - Viewport Safe */
        .page-card { 
            width: 100%; 
            position: relative; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            max-height: calc(100vh - 200px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .page-card .content-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        
        .page-card canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .grid-zoom-container[data-columns="1"] .page-card { 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            max-height: calc(100vh - 150px);
        }
        
        .grid-zoom-container[data-columns="1"] .page-card:hover { 
            transform: translateY(-4px); 
        }
        
        /* Responsive height adjustments */
        @media (max-height: 700px) {
            .page-card { max-height: calc(100vh - 150px); }
        }
        @media (max-height: 600px) {
            .page-card { max-height: calc(100vh - 120px); }
        }

        /* Sortable Styles */
        .sortable-ghost { opacity: 0.8; background: linear-gradient(135deg, #6366f115 0%, #818cf815 100%); border: 2px solid #6366f1; border-radius: 0.75rem; transform: scale(1.08); z-index: 1000; }
        .sortable-drag { background: white; transform: scale(1.12) translateY(-2px); z-index: 1000; filter: brightness(1.15); }
        .page-card.dragging { transition: all 0.08s !important; }
        
        /* Dark mode overrides */
        .dark .page-card.bg-white { background-color: #1e293b; }

        /* ✅ NEW: Floating Toolbar Margin Fix */
        #floatingToolbar {
            margin: 0 1rem; /* Keep within bounds */
        }

        /* ✅ NEW: Prevent any horizontal overflow */
        .overflow-safe {
            overflow-x-hidden !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-700 bg-slate-50 dark:bg-darkSurface dark:text-slate-300 transition-colors duration-300 overflow-x-hidden">

    <!-- Drop Zone -->
    <div id="dropOverlay" class="fixed inset-0 z-[100] bg-brand/90 dark:bg-indigo-950/90 hidden flex-col items-center justify-center opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-slate-800 p-12 rounded-3xl shadow-2xl text-center transform scale-110 border border-white/20 drop-zone-active">
            <i class="fa-solid fa-cloud-arrow-up text-7xl text-brand dark:text-indigo-400 mb-6 animate-bounce"></i>
            <h2 class="text-3xl font-bold text-slate-800 dark:text-white">釋放文件以加入</h2>
            <p class="text-slate-500 dark:text-slate-400 mt-2 font-medium">支援 PDF、JPG、PNG</p>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200/60 dark:border-slate-800/60 h-16 flex items-center justify-between px-6 z-20 flex-shrink-0 sticky top-0">
        <div class="flex items-center gap-4 flex-1 min-w-0">
            <div class="flex items-center gap-3 group cursor-pointer" onclick="location.reload()">
                <div class="bg-gradient-to-br from-brand to-indigo-600 text-white p-2 rounded-xl shadow-lg">
                    <i class="fa-solid fa-layer-group text-lg"></i>
                </div>
                <div id="appTitle">
                    <h1 class="font-bold text-lg tracking-tight text-slate-800 dark:text-white">PDF Organizer<span class="text-[10px] bg-indigo-100 text-brand px-1.5 py-0.5 rounded-md ml-1">PRO</span></h1>
                </div>
            </div>

            <div id="fileInfo" class="hidden items-center gap-3 pl-4 border-l border-slate-200 dark:border-slate-700">
                <div class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg px-3 py-1.5 border border-slate-200 dark:border-slate-700">
                    <i class="fa-regular fa-file-pdf text-red-500 mr-2"></i>
                    <input type="text" id="fileNameInput" class="filename-input font-medium text-sm w-48 truncate text-slate-700 dark:text-slate-200 placeholder-slate-400" value="merged_document" onblur="fileName = this.value">
                </div>
                <span id="pageCountDisplay" class="text-xs font-medium text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">0 頁</span>
                <button onclick="closeAllFiles()" class="w-7 h-7 flex items-center justify-center rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition ml-1" title="關閉所有"><i class="fa-solid fa-times"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="toggleDarkMode()" class="w-9 h-9 flex items-center justify-center rounded-full text-slate-500 hover:bg-slate-100 hover:text-brand transition" title="切換主題"><i class="fa-solid fa-moon dark:hidden"></i><i class="fa-solid fa-sun hidden dark:inline"></i></button>
            
            <div id="settingsBtnGroup" class="hidden">
                <div class="relative group">
                    <button class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium text-slate-600 hover:bg-slate-100 hover:text-brand dark:text-slate-300 dark:hover:bg-slate-800 transition border border-transparent hover:border-slate-200">
                        <i class="fa-solid fa-sliders"></i> <span>設定</span>
                    </button>
                    <div class="absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 hidden group-hover:block z-50">
                        <div class="py-1.5">
                            <button onclick="toggleModal('pageNumberModal')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3"><i class="fa-solid fa-list-ol w-4"></i> 插入頁碼</button>
                            <button onclick="toggleModal('metadataModal')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3"><i class="fa-solid fa-tags w-4"></i> 元數據</button>
                            <button onclick="toggleModal('watermarkModal')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3"><i class="fa-solid fa-stamp w-4"></i> 浮水印</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>

            <button id="addFileBtn" onclick="document.getElementById('fileInput').click()" class="bg-slate-900 hover:bg-slate-800 dark:bg-white dark:hover:bg-slate-200 text-white dark:text-slate-900 px-4 py-2 rounded-lg text-sm font-semibold transition shadow-md flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> <span id="addFileLabel">開啟 PDF</span>
            </button>
            <input type="file" id="fileInput" accept=".pdf,image/jpeg,image/png" multiple class="hidden" onchange="handleFiles(this.files)">

            <!-- Export Button Group -->
            <div id="exportBtnGroup" class="relative hidden">
                <button class="bg-brand hover:bg-brandHover text-white px-5 py-2 rounded-lg text-sm font-semibold transition shadow-md flex items-center gap-2" onclick="toggleExportDropdown()">
                    <span>匯出</span><i class="fa-solid fa-chevron-down text-xs opacity-70 ml-1"></i>
                </button>
                <div id="exportDropdown" class="absolute right-0 mt-3 w-60 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 hidden z-50">
                    <div class="p-1.5">
                        <button onclick="exportFile('pdf'); toggleExportDropdown(false)" class="w-full text-left px-3 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg flex items-center gap-3"><i class="fa-solid fa-file-pdf text-red-500"></i> PDF 文件</button>
                        <button onclick="exportFile('zip'); toggleExportDropdown(false)" class="w-full text-left px-3 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg flex items-center gap-3"><i class="fa-solid fa-file-zipper text-yellow-500"></i> 獨立 PDF (ZIP)</button>
                        <button onclick="exportFile('images'); toggleExportDropdown(false)" class="w-full text-left px-3 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg flex items-center gap-3"><i class="fa-regular fa-image text-blue-500"></i> 圖片序列 (JPG)</button>
                        <button onclick="exportFile('text'); toggleExportDropdown(false)" class="w-full text-left px-3 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg flex items-center gap-3"><i class="fa-solid fa-align-left text-slate-500"></i> 純文字 (TXT)</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden pr-4 overflow-safe" id="mainArea" style="height: calc(100vh - 64px); max-height: calc(100vh - 64px);">
        <!-- Empty State -->
        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center z-0 px-4">
            <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm p-12 rounded-3xl border border-slate-200 dark:border-slate-700 text-center max-w-lg w-full transition-all hover:shadow-xl">
                <div class="w-24 h-24 bg-white dark:bg-slate-700 text-brand rounded-3xl flex items-center justify-center mx-auto mb-8 text-4xl shadow-soft"><i class="fa-solid fa-folder-open"></i></div>
                <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-4">混合工作台</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-10 leading-relaxed">支援多個 PDF 與圖片混合編輯。<br>拖放檔案至此，或點擊下方按鈕。</p>
                <button onclick="document.getElementById('fileInput').click()" class="bg-brand hover:bg-brandHover text-white px-10 py-4 rounded-xl font-semibold shadow-lg transition transform hover:-translate-y-1 flex justify-center items-center gap-3 mx-auto"><i class="fa-solid fa-plus"></i> 開始新增檔案</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div id="topBar" class="h-14 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-b border-slate-200/60 dark:border-slate-800/60 flex items-center justify-between px-6 hidden z-10">
            <div class="flex items-center gap-4 text-sm">
                <div class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg p-1 mr-2 shadow-sm">
                    <button onclick="undo()" id="btnUndo" disabled class="w-8 h-8 flex items-center justify-center rounded hover:bg-white dark:hover:bg-slate-700 disabled:opacity-30 transition"><i class="fa-solid fa-arrow-rotate-left"></i></button>
                    <button onclick="redo()" id="btnRedo" disabled class="w-8 h-8 flex items-center justify-center rounded hover:bg-white dark:hover:bg-slate-700 disabled:opacity-30 transition"><i class="fa-solid fa-arrow-rotate-right"></i></button>
                </div>
                <div class="h-4 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                <button onclick="selectAll()" class="hover:text-brand transition px-2 py-1 rounded hover:bg-slate-100">全選</button>
                <button onclick="deselectAll()" class="hover:text-brand transition px-2 py-1 rounded hover:bg-slate-100">取消</button>
                <span class="bg-indigo-50 dark:bg-indigo-900/30 text-brand px-3 py-1 rounded-full text-xs font-bold ml-2" id="selectionBadge">0 選取</span>
                <div class="flex items-center gap-1 ml-2 border-l border-slate-200 dark:border-slate-700 pl-3">
                    <button onclick="rotateAll(90)" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-brand transition" title="全部向右旋轉"><i class="fa-solid fa-rotate"></i></button>
                    <button onclick="reverseOrder()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-brand transition" title="反向排序"><i class="fa-solid fa-sort"></i></button>
                    <button onclick="resetPageOrder()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-red-500 transition" title="重置"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="statusBadges" class="flex gap-2"></div>
                
                <!-- Zoom Controls -->
                <div class="zoom-controls">
                    <i class="fas fa-th zoom-icon" id="zoomOutIcon" title="網格檢視"></i>
                    <div class="slider-container">
                        <div class="slider-background"></div>
                        <input type="range" id="zoomSlider" min="0" max="4" step="1" value="2">
                    </div>
                    <i class="fas fa-file zoom-icon" id="zoomInIcon" title="單頁檢視"></i>
                    <div class="zoom-label" id="zoomLabel">3 欄</div>
                </div>
            </div>
        </div>

        <!-- Grid -->
        <div id="gridWrapper" class="flex-1 overflow-y-auto overflow-x-hidden p-8 pr-2 pl-6 pb-8 hidden scroll-smooth overflow-safe bg-slate-50/50 dark:bg-slate-950/50" style="max-height: calc(100vh - 100px); height: calc(100vh - 100px); scroll-behavior: smooth; overscroll-behavior: contain;">
            <div id="gridContainer" class="grid-zoom-container" style="--col-count: 3" data-columns="3"></div>
        </div>

        <!-- NEW Floating Toolbar -->
        <div id="floatingToolbar" class="absolute bottom-10 left-1/2 transform -translate-x-1/2 bg-[#2B3245] text-white px-4 py-2.5 rounded-full shadow-2xl border border-white/10 hidden items-center gap-3 z-50 transition-all duration-300 animate-slide-up ring-1 ring-black/20">
            
            <!-- Rotation Group -->
            <div class="flex items-center gap-1">
                <button onclick="rotateSelected(-90)" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-full transition text-slate-200 hover:text-white" title="向左旋轉 90°">
                    <i class="fa-solid fa-rotate-left text-lg"></i>
                </button>
                <button onclick="rotateSelected(90)" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-full transition text-slate-200 hover:text-white" title="向右旋轉 90°">
                    <i class="fa-solid fa-rotate-right text-lg"></i>
                </button>
            </div>

            <!-- Divider -->
            <div class="w-px h-6 bg-white/20 mx-1"></div>

            <!-- Edit Group -->
            <div class="flex items-center gap-1">
                <button onclick="addBlankPage()" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-full transition text-slate-200 hover:text-white" title="新增頁面">
                    <i class="fa-regular fa-square-plus text-xl"></i>
                </button>
                <button onclick="copySelected()" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-full transition text-slate-200 hover:text-white" title="複製頁面">
                    <i class="fa-regular fa-copy text-lg"></i>
                </button>
                <button id="pasteBtn" onclick="pastePages()" disabled class="w-10 h-10 flex items-center justify-center hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-transparent rounded-full transition text-slate-200 hover:text-white" title="貼上頁面">
                    <i class="fa-regular fa-paste text-lg"></i>
                </button>
            </div>

            <!-- Divider -->
            <div class="w-px h-6 bg-white/20 mx-1"></div>

            <!-- Delete Group -->
            <div>
                <button onclick="deleteSelected()" class="w-10 h-10 flex items-center justify-center hover:bg-red-500/20 text-red-400 hover:text-red-300 rounded-full transition" title="刪除所選">
                    <i class="fa-solid fa-trash-can text-lg"></i>
                </button>
            </div>
        </div>

    </main>

    <!-- Modals & Toasts -->
    <div id="pageNumberModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4">
            <h3 class="font-bold text-lg dark:text-white">頁碼設定</h3>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setPagePos('bottom-left')" class="pn-btn border p-2 rounded hover:bg-indigo-50 dark:text-white" data-pos="bottom-left">左下</button>
                <button onclick="setPagePos('bottom-center')" class="pn-btn border p-2 rounded bg-indigo-50 border-indigo-500 text-indigo-600" data-pos="bottom-center">置中</button>
                <button onclick="setPagePos('bottom-right')" class="pn-btn border p-2 rounded hover:bg-indigo-50 dark:text-white" data-pos="bottom-right">右下</button>
            </div>
            <input id="pnStart" type="number" value="1" class="w-full border rounded p-2 dark:bg-slate-900 dark:text-white" placeholder="起始頁碼">
            <div class="flex justify-end gap-2">
                <button onclick="setPageSettings(null)" class="px-4 py-2 text-red-500">清除</button>
                <button onclick="setPageSettings(true)" class="px-4 py-2 bg-brand text-white rounded">確認</button>
            </div>
            <button onclick="toggleModal('pageNumberModal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <div id="metadataModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4 relative">
            <h3 class="font-bold text-lg dark:text-white">元數據</h3>
            <input id="metaTitle" class="w-full border rounded p-2 dark:bg-slate-900 dark:text-white" placeholder="標題">
            <input id="metaAuthor" class="w-full border rounded p-2 dark:bg-slate-900 dark:text-white" placeholder="作者">
            <div class="flex justify-end"><button onclick="saveMeta()" class="px-4 py-2 bg-brand text-white rounded">儲存</button></div>
            <button onclick="toggleModal('metadataModal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <div id="watermarkModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4 relative">
            <h3 class="font-bold text-lg dark:text-white">浮水印</h3>
            <input id="wmText" class="w-full border rounded p-2 dark:bg-slate-900 dark:text-white" placeholder="文字">
            <input id="wmColor" type="color" class="w-full h-10 rounded" value="#ff0000">
            <input id="wmOpacity" type="range" min="0.1" max="1" step="0.1" value="0.3" class="w-full">
            <div class="flex justify-end gap-2">
                <button onclick="saveWatermark(null)" class="px-4 py-2 text-red-500">清除</button>
                <button onclick="saveWatermark(true)" class="px-4 py-2 bg-brand text-white rounded">儲存</button>
            </div>
            <button onclick="toggleModal('watermarkModal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <div id="loadingModal" class="fixed inset-0 bg-white/90 z-50 hidden flex flex-col items-center justify-center">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12 mb-4"></div>
        <p id="loadingText" class="text-slate-600 font-bold">處理中...</p>
    </div>
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 pointer-events-none z-[100] transition-opacity duration-300"></div>

    <script>
        // --- Global State (Flat & Simple) ---
        let fileStore = {}; // { id: { type: 'pdf'|'image', name, data, pdfDoc } }
        let fileManifest = []; // [docId1, docId2...] for Reset
        let pages = [];     // { id, fileId, pageIndex, rotation, type }
        let selectedIds = new Set();
        let clipboard = [];
        let history = [];
        let historyIndex = -1;
        
        // Config
        let metaConfig = null;
        let wmConfig = null;
        let pgNumConfig = null;
        let sortableInstance = null;
        let fileName = "merged_document";
        let exportDropdownOpen = false; 

        // --- Grid Zoom Configuration ---
        const gridContainer = document.getElementById('gridContainer');
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomLabel = document.getElementById('zoomLabel');
        const zoomOutIcon = document.getElementById('zoomOutIcon');
        const zoomInIcon = document.getElementById('zoomInIcon');
        const gridWrapper = document.getElementById('gridWrapper');

        const stepMap = {
            0: { cols: 5, label: "網格檢視" },
            1: { cols: 4, label: "4 欄" },
            2: { cols: 3, label: "3 欄" },
            3: { cols: 2, label: "2 欄" },
            4: { cols: 1, label: "閱讀模式" }
        };

        // ✅ NEW: Viewport-Aware Scaling Function
        function getOptimalScale() {
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            const columns = parseInt(gridContainer.getAttribute('data-columns') || 3);
            
            let scale = 0.5; // default
            
            if (columns === 1) {
                // Reading mode: larger, but fit in viewport
                scale = Math.min(1.8, viewportHeight / 850);
            } else if (columns === 2) {
                scale = Math.min(0.9, viewportHeight / 600);
            } else if (columns === 3) {
                scale = Math.min(0.6, viewportHeight / 500);
            } else if (columns === 4) {
                scale = Math.min(0.45, viewportHeight / 450);
            } else if (columns === 5) {
                scale = Math.min(0.35, viewportHeight / 400);
            }
            
            return Math.max(scale, 0.25); // minimum readability
        }

        function getMostVisiblePage() {
            const viewportRect = gridWrapper.getBoundingClientRect();
            const pages = document.querySelectorAll('.page-card');
            let bestPage = null;
            let maxVisibility = 0;
            pages.forEach(page => {
                const rect = page.getBoundingClientRect();
                const visibleTop = Math.max(rect.top, viewportRect.top);
                const visibleBottom = Math.min(rect.bottom, viewportRect.bottom);
                const visibleHeight = Math.max(0, visibleBottom - visibleTop);
                if (visibleHeight > maxVisibility) { maxVisibility = visibleHeight; bestPage = page; }
            });
            return bestPage;
        }

        function updateZoomIndicators(value) {
            const config = stepMap[value];
            zoomOutIcon.classList.toggle('active', value === 0);
            zoomInIcon.classList.toggle('active', value === 4);
            zoomLabel.textContent = config.label;
            zoomLabel.classList.toggle('active', true);
            const track = document.querySelector('.slider-background');
            if (track) {
                const progress = (value / 4) * 100;
                const isDark = document.documentElement.classList.contains('dark');
                const startColor = '#6366f1';
                const endColor = isDark ? '#475569' : '#cbd5e1';
                track.style.background = `linear-gradient(90deg, ${startColor} 0%, ${startColor} ${progress}%, ${endColor} ${progress}%, ${endColor} 100%)`;
            }
        }

        // **Smart Pre-rendering on Scroll**
        let scrollTimeout;
        gridWrapper.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(reRenderVisibleThumbnails, 150);
        });

        function reRenderVisibleThumbnails() {
            const cards = document.querySelectorAll('.page-card');
            const viewportRect = gridWrapper.getBoundingClientRect();
            const cols = gridContainer.getAttribute('data-columns');
            const buffer = cols === '1' ? viewportRect.height * 1.5 : 400;

            const visibleCards = Array.from(cards).filter(card => {
                const rect = card.getBoundingClientRect();
                return rect.bottom > viewportRect.top - buffer && 
                       rect.top < viewportRect.bottom + buffer;
            });

            // 分批渲染避免卡顿
            visibleCards.forEach((card, i) => {
                setTimeout(() => {
                    const pageId = card.dataset.id;
                    const page = pages.find(p => p.id === pageId);
                    if (page) renderThumbnail(page, false);
                }, i * 10);
            });
        }

        function initZoomControls() {
            zoomSlider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                const config = stepMap[val];
                const anchorPage = getMostVisiblePage();
                gridContainer.style.setProperty('--col-count', config.cols);
                gridContainer.setAttribute('data-columns', config.cols);
                updateZoomIndicators(val);
                if (anchorPage) {
                    setTimeout(() => {
                        anchorPage.scrollIntoView({ behavior: 'auto', block: 'center' });
                    }, 0);
                }
                // ✅ Re-render thumbnails after zoom change
                setTimeout(reRenderVisibleThumbnails, 100);
            });
            zoomSlider.addEventListener('change', () => {
                setTimeout(reRenderVisibleThumbnails, 100);
            });
            
            gridWrapper.addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    e.preventDefault();
                    const direction = e.deltaY > 0 ? -1 : 1; 
                    const currentVal = parseInt(zoomSlider.value);
                    const newVal = Math.min(Math.max(currentVal + direction, 0), 4);
                    if (newVal !== currentVal) {
                        zoomSlider.value = newVal;
                        zoomSlider.dispatchEvent(new Event('input'));
                        clearTimeout(window.wheelZoomTimeout);
                        window.wheelZoomTimeout = setTimeout(reRenderVisibleThumbnails, 300);
                    }
                }
            }, { passive: false });
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            initZoomControls();
            initTheme();
            
            const dropOverlay = document.getElementById('dropOverlay');
            let dragCounter = 0;
            const isFile = e => e.dataTransfer.types && Array.from(e.dataTransfer.types).includes('Files');

            window.addEventListener('dragenter', e => {
                if(isFile(e)) {
                    e.preventDefault(); 
                    dragCounter++; 
                    dropOverlay.classList.remove('hidden'); 
                    setTimeout(() => dropOverlay.classList.remove('opacity-0'), 10); 
                }
            });
            window.addEventListener('dragleave', e => {
                if(isFile(e)) {
                    e.preventDefault(); 
                    dragCounter--; 
                    if(dragCounter === 0) { 
                        dropOverlay.classList.add('opacity-0'); 
                        setTimeout(() => dropOverlay.classList.add('hidden'), 200); 
                    } 
                }
            });
            window.addEventListener('dragover', e => { if(isFile(e)) e.preventDefault(); });
            window.addEventListener('drop', e => {
                if(isFile(e)) {
                    e.preventDefault(); 
                    dragCounter = 0; 
                    dropOverlay.classList.add('opacity-0');
                    setTimeout(() => dropOverlay.classList.add('hidden'), 200);
                    handleFiles(e.dataTransfer.files);
                }
            });

            document.addEventListener('click', (e) => {
                const exportGroup = document.getElementById('exportBtnGroup');
                if (exportGroup && !exportGroup.contains(e.target)) { toggleExportDropdown(false); }
            });

            document.addEventListener('keydown', handleKeys);
            document.getElementById('gridWrapper').addEventListener('click', (e) => { 
                if(e.target.id === 'gridWrapper' || e.target.id === 'gridContainer') deselectAll(); 
            });
        });

        function toggleExportDropdown(show) {
            const dropdown = document.getElementById('exportDropdown');
            exportDropdownOpen = (show === undefined) ? !exportDropdownOpen : show;
            dropdown.classList.toggle('hidden', !exportDropdownOpen);
        }

        function initSortable() {
            if(sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(gridContainer, {
                animation: 250, 
                easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)', 
                ghostClass: 'sortable-ghost', 
                dragClass: 'sortable-drag', 
                chosenClass: 'sortable-chosen', 
                dragoverBubble: false, 
                handle: '.page-card', 
                forceFallback: false, 
                fallbackTolerance: 0,
                onStart: function(evt) { 
                    evt.item.style.transition = 'all 0.1s cubic-bezier(0.34, 1.56, 0.64, 1)'; 
                },
                onChoose: function(evt) { 
                    evt.item.classList.add('dragging'); 
                    evt.item.style.transition = 'all 0.08s cubic-bezier(0.34, 1.56, 0.64, 1)'; 
                },
                onEnd: function(evt) {
                    evt.item.classList.remove('dragging');
                    evt.item.style.transition = 'transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.15s ease-out, filter 0.15s ease-out';
                    if (evt.oldIndex !== evt.newIndex) {
                        recordHistory();
                        const item = pages.splice(evt.oldIndex, 1)[0];
                        pages.splice(evt.newIndex, 0, item);
                        updateAllPageNumbers();
                        showToast(`頁面已移動到位置 ${evt.newIndex + 1}`);
                    }
                },
                onMove: function(evt, originalEvent) {
                    if (evt.related && evt.related.classList.contains('page-card')) {
                        evt.related.style.transition = 'box-shadow 0.1s ease-out, filter 0.1s ease-out';
                        evt.related.style.boxShadow = '0 0 0 4px rgba(99, 102, 241, 0.4)';
                        evt.related.style.filter = 'brightness(1.05)';
                    }
                    if (evt.dragged) { 
                        evt.dragged.style.transition = 'all 0.08s cubic-bezier(0.34, 1.56, 0.64, 1)'; 
                    }
                    return true;
                },
                onLeave: function(evt) {
                    if (evt.related && evt.related.classList.contains('page-card')) {
                        evt.related.style.transition = 'box-shadow 0.15s ease-out, filter 0.15s ease-out';
                        evt.related.style.boxShadow = '';
                        evt.related.style.filter = '';
                    }
                }
            });
        }

        // ✅ 新增：更新所有页面序号
        function updateAllPageNumbers() {
            const container = gridContainer;
            Array.from(container.children).forEach((child, index) => {
                const pageNumberSpan = child.querySelector('span:first-child');
                if (pageNumberSpan) {
                    pageNumberSpan.textContent = `Pg ${index + 1}`;
                }
            });
            updateSelectionStates();
        }

        async function handleFiles(fileList) {
            if (!fileList.length) return;
            showLoading(true);
            try {
                recordHistory();
                for (let file of fileList) {
                    const docId = crypto.randomUUID();
                    const buffer = await file.arrayBuffer();
                    fileManifest.push(docId); 
                    
                    if (file.type === 'application/pdf') {
                        const pdfDoc = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
                        fileStore[docId] = { type: 'pdf', name: file.name, data: buffer, pdfDoc };
                        for (let i = 0; i < pdfDoc.numPages; i++) {
                            pages.push({ id: crypto.randomUUID(), fileId: docId, pageIndex: i, rotation: 0, type: 'pdf' });
                        }
                    } else if (file.type.startsWith('image/')) {
                        fileStore[docId] = { type: 'image', name: file.name, data: buffer, mime: file.type };
                        pages.push({ id: crypto.randomUUID(), fileId: docId, pageIndex: 0, rotation: 0, type: 'image' });
                    }
                }

                // ✅ 安全处理文件名
                if (fileList.length > 0 && fileName === 'merged_document') {
                    fileName = fileList[0].name.split('.').slice(0, -1).join('.');
                    document.getElementById('fileNameInput').value = fileName;
                }

                renderGrid();
                updateUI();
                zoomSlider.value = "2";
                updateZoomIndicators(2);
                showToast("檔案已加入");
            } catch (e) {
                console.error(e);
                showToast("讀取失敗", true);
            } finally {
                showLoading(false);
            }
        }

        function resetPageOrder() {
            if (!fileManifest.length) return;
            if(confirm("確定重置為原始狀態？")) {
                recordHistory();
                pages = []; 
                for (let docId of fileManifest) {
                    const file = fileStore[docId];
                    if(!file) continue;
                    if(file.type === 'pdf') {
                        for(let i = 0; i < file.pdfDoc.numPages; i++) {
                            pages.push({ id: crypto.randomUUID(), fileId: docId, pageIndex: i, rotation: 0, type: 'pdf' });
                        }
                    } else if (file.type === 'image') {
                        pages.push({ id: crypto.randomUUID(), fileId: docId, pageIndex: 0, rotation: 0, type: 'image' });
                    }
                }
                selectedIds.clear();
                zoomSlider.value = "2";
                updateZoomIndicators(2);
                gridContainer.style.setProperty('--col-count', 3);
                gridContainer.setAttribute('data-columns', 3);
                renderGrid(true); 
                updateUI();
                showToast("已重置");
            }
        }

        function createPageCard(p, i) {
            const el = document.createElement('div');
            const isSel = selectedIds.has(p.id);
            const isLandscape = p.rotation % 180 !== 0;
            const aspectRatio = isLandscape ? '297/210' : '210/297';
            
            el.className = `page-card bg-white dark:bg-darkCard rounded-xl p-2 cursor-pointer relative group border-2 ${isSel ? 'border-brand ring-2 ring-brand/20' : 'border-transparent hover:border-indigo-200'}`;
            el.style.aspectRatio = aspectRatio;
            el.dataset.id = p.id;
            el.onclick = (e) => toggleSelect(p.id, e.ctrlKey || e.metaKey);
            
            el.innerHTML = `
                <div class="relative bg-slate-100 rounded mb-2 overflow-hidden flex items-center justify-center shadow-lg border border-slate-200 dark:border-slate-700 h-full content-area">
                    <div class="w-full h-full flex items-center justify-center">
                        <canvas id="cvs-${p.id}" class="max-w-full max-h-full object-contain"></canvas>
                    </div>
                    <div class="absolute top-1 left-1 w-5 h-5 rounded-full ${isSel ? 'bg-brand' : 'bg-black/20'} flex items-center justify-center text-white text-xs">
                        <i class="fa-solid fa-check ${isSel ? '' : 'opacity-0'}"></i>
                    </div>
                </div>
                <div class="flex justify-between items-center text-[10px] font-bold text-slate-500">
                    <span>Pg ${i+1}</span>
                    <span class="${p.type==='pdf' ? 'bg-red-100 text-red-600' : p.type==='image' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600'} px-1 rounded uppercase">${p.type}</span>
                </div>
            `;
            return el;
        }

        // ✅ ENHANCED: Viewport-Aware Thumbnail Rendering
        async function renderThumbnail(p, forceHighQuality = false) {
            const cvs = document.getElementById(`cvs-${p.id}`);
            if (!cvs || p.type === 'blank') return;
            const file = fileStore[p.fileId];
            if (!file) return;

            try {
                // ✅ Use dynamic scaling based on viewport and columns
                const scale = getOptimalScale();
                
                // Cache key includes dynamic scale
                const renderKey = `${p.fileId}-${p.pageIndex}-${scale}-${p.rotation}-${p.type}`;
                if (cvs.dataset.lastRender === renderKey && !forceHighQuality) return;

                const ctx = cvs.getContext('2d');
                ctx.setTransform(1, 0, 0, 1, 0, 0);

                if (p.type === 'pdf') {
                    const page = await file.pdfDoc.getPage(p.pageIndex + 1);
                    const viewport = page.getViewport({ scale: scale, rotation: p.rotation });
                    
                    // ✅ Ensure canvas fits in container
                    const columns = parseInt(gridContainer.getAttribute('data-columns') || 3);
                    const maxWidth = (gridWrapper.clientWidth - 48) / columns - 20;
                    const maxHeight = window.innerHeight - 200;
                    
                    let finalWidth = viewport.width;
                    let finalHeight = viewport.height;
                    
                    if (finalWidth > maxWidth) {
                        const ratio = maxWidth / finalWidth;
                        finalWidth *= ratio;
                        finalHeight *= ratio;
                    }
                    if (finalHeight > maxHeight) {
                        const ratio = maxHeight / finalHeight;
                        finalWidth *= ratio;
                        finalHeight *= ratio;
                    }
                    
                    cvs.width = finalWidth;
                    cvs.height = finalHeight;
                    
                    const renderViewport = page.getViewport({ scale: scale * (finalWidth / viewport.width), rotation: p.rotation });
                    await page.render({ canvasContext: ctx, viewport: renderViewport }).promise;
                    
                } else if (p.type === 'image') {
                    const img = new Image();
                    const blob = new Blob([file.data], {type: file.mime});
                    img.src = URL.createObjectURL(blob);
                    
                    await new Promise((resolve, reject) => {
                        img.onload = () => {
                            URL.revokeObjectURL(img.src);
                            
                            const columns = parseInt(gridContainer.getAttribute('data-columns') || 3);
                            const maxWidth = (gridWrapper.clientWidth - 48) / columns - 20;
                            const maxHeight = window.innerHeight - 200;
                            
                            let finalWidth = img.width * scale;
                            let finalHeight = img.height * scale;
                            
                            if (p.rotation % 180 !== 0) {
                                [finalWidth, finalHeight] = [finalHeight, finalWidth];
                            }
                            
                            if (finalWidth > maxWidth || finalHeight > maxHeight) {
                                const ratio = Math.min(maxWidth / finalWidth, maxHeight / finalHeight);
                                finalWidth *= ratio;
                                finalHeight *= ratio;
                            }
                            
                            cvs.width = finalWidth;
                            cvs.height = finalHeight;
                            
                            ctx.setTransform(1, 0, 0, 1, 0, 0);
                            ctx.translate(cvs.width / 2, cvs.height / 2);
                            ctx.rotate(p.rotation * Math.PI / 180);
                            ctx.drawImage(img, -finalWidth / 2, -finalHeight / 2, finalWidth, finalHeight);
                            
                            resolve();
                        };
                        img.onerror = reject;
                        setTimeout(reject, 3000);
                    });
                }
                
                cvs.dataset.lastRender = renderKey;

            } catch (e) {
                console.warn(`Failed to render page ${p.id}:`, e);
                const ctx = cvs.getContext('2d');
                ctx.fillStyle = '#f1f5f9';
                ctx.fillRect(0, 0, 100, 140);
                ctx.fillStyle = '#64748b';
                ctx.font = 'bold 12px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(p.type === 'pdf' ? 'PDF' : 'IMG', 50, 70);
            }
        }

        function toggleSelect(id, multi) {
            if (!multi) selectedIds.clear();
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            updateSelectionStates();
            updateUI();
            const index = pages.findIndex(p => p.id === id);
            if (index !== -1) { renderNeighborhood(index); }
            
            // ✅ 安全调用震动
            if (navigator.vibrate && 'vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }
        
        function renderNeighborhood(index) {
            const targets = [index - 1, index, index + 1];
            targets.forEach(i => {
                if (pages[i]) { 
                    setTimeout(() => renderThumbnail(pages[i], true), 10); 
                }
            });
        }
        
        function updateSelectionStates() {
            const container = gridContainer;
            const cards = container.children;
            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];
                const pageId = card.dataset.id;
                const isSel = selectedIds.has(pageId);
                if (isSel) {
                    card.classList.add('border-brand', 'ring-2', 'ring-brand/20');
                    card.classList.remove('border-transparent', 'hover:border-indigo-200');
                    const checkmark = card.querySelector('.fa-check');
                    if (checkmark) checkmark.classList.remove('opacity-0');
                } else {
                    card.classList.remove('border-brand', 'ring-2', 'ring-brand/20');
                    card.classList.add('border-transparent', 'hover:border-indigo-200');
                    const checkmark = card.querySelector('.fa-check');
                    if (checkmark) checkmark.classList.add('opacity-0');
                }
            }
        }
        
        function selectAll() { 
            pages.forEach(p => selectedIds.add(p.id)); 
            updateSelectionStates(); 
            updateUI(); 
            showToast(`已選擇 ${pages.length} 項`); 
        }
        
        function deselectAll() { 
            selectedIds.clear(); 
            updateSelectionStates(); 
            updateUI(); 
        }
        
        function rotateAll(angle) { 
            if (!pages.length) return; 
            recordHistory(); 
            pages.forEach(p => p.rotation = (p.rotation + angle) % 360); 
            updateRotationStates(); 
            showToast(`全部旋轉 ${angle}°`);
        }
        
        function rotateSelected(angle) { 
            if (!selectedIds.size) return; 
            recordHistory(); 
            pages.forEach(p => { 
                if(selectedIds.has(p.id)) p.rotation = (p.rotation + angle) % 360; 
            }); 
            updateRotationStates(); 
            showToast(`旋轉 ${selectedIds.size} 項`);
        }
        
        function updateRotationStates() { 
            updateAllPageNumbers(); 
            pages.forEach(p => { 
                if(selectedIds.size === 0 || selectedIds.has(p.id)) { 
                    renderThumbnail(p); 
                } 
            }); 
        }
        
        function deleteSelected() { 
            if (!selectedIds.size) return; 
            recordHistory(); 
            const deletedCount = selectedIds.size;
            pages = pages.filter(p => !selectedIds.has(p.id)); 
            selectedIds.clear(); 
            renderGrid(true); 
            updateUI(); 
            showToast(`已刪除 ${deletedCount} 項`);
        }
        
        function addBlankPage() { 
            recordHistory(); 
            pages.push({ id: crypto.randomUUID(), type: 'blank', rotation: 0 }); 
            renderGrid(true); 
            updateUI(); 
            showToast("已新增空白頁");
        }
        
        function copySelected() { 
            if (!selectedIds.size) return; 
            clipboard = pages.filter(p => selectedIds.has(p.id)).map(p => ({...p})); 
            updateUI(); 
            showToast(`已複製 ${clipboard.length} 項`);
        }
        
        function pastePages() { 
    if (!clipboard.length) return; 
    recordHistory(); 
    
    // 找出當前選中的頁面位置
    const selectedIndices = [];
    pages.forEach((p, index) => {
        if (selectedIds.has(p.id)) {
            selectedIndices.push(index);
        }
    });
    
    // 如果有選中的頁面，插入到最後一個選中頁面之後
    // 如果沒有選中的頁面，插入到開頭
    let insertIndex;
    if (selectedIndices.length > 0) {
        insertIndex = Math.max(...selectedIndices) + 1;
    } else {
        insertIndex = 0;
    }
    
    // 創建新的項目
    const newItems = clipboard.map(p => ({...p, id: crypto.randomUUID()}));
    
    // 使用 splice 插入到指定位置
    pages.splice(insertIndex, 0, ...newItems);
    
    // 清除選擇並選擇新貼上的頁面
    selectedIds.clear();
    newItems.forEach(item => selectedIds.add(item.id));
    
    renderGrid(true); 
    updateUI(); 
    updateSelectionStates();
    showToast(`已貼上 ${newItems.length} 項`);
}
        
        function reverseOrder() { 
            recordHistory(); 
            pages.reverse(); 
            updateAllPageNumbers(); 
            showToast("順序已反轉");
        }
        
        function closeAllFiles() { 
            if(confirm("關閉所有文件？")) { 
                pages = []; 
                fileStore = {}; 
                fileManifest = []; 
                selectedIds.clear(); 
                history = []; 
                renderGrid(true); 
                zoomSlider.value = "2"; 
                updateZoomIndicators(2); 
                zoomSlider.dispatchEvent(new Event('input'));
                updateUI(); 
                showToast("已關閉所有文件");
            } 
        }

        function recordHistory() {
            if(historyIndex < history.length-1) history = history.slice(0, historyIndex+1);
            history.push(JSON.parse(JSON.stringify(pages)));
            if(history.length > 20) history.shift(); else historyIndex++;
            updateUndoRedoButtons();
        }
        
        function undo() { 
            if(historyIndex >= 0) { 
                pages = history[historyIndex]; 
                historyIndex--; 
                renderGrid(true); 
                updateUI(); 
                showToast("已復原"); 
            } 
        }
        
        function redo() { 
            if(historyIndex < history.length - 1) { 
                historyIndex++; 
                pages = history[historyIndex]; 
                renderGrid(true); 
                updateUI(); 
                showToast("已重做"); 
            } 
        }
        
        function updateUndoRedoButtons() { 
            document.getElementById('btnUndo').disabled = historyIndex < 0; 
            document.getElementById('btnRedo').disabled = historyIndex >= history.length - 1; 
        }

        function updateUI() {
            const hasPages = pages.length > 0;
            const empty = document.getElementById('emptyState');
            const main = document.getElementById('topBar');
            const grid = document.getElementById('gridWrapper');
            const info = document.getElementById('fileInfo');
            const addLabel = document.getElementById('addFileLabel');
            const exportGrp = document.getElementById('exportBtnGroup');
            const settGrp = document.getElementById('settingsBtnGroup');
            const title = document.getElementById('appTitle');
            const floatBar = document.getElementById('floatingToolbar');

            if (hasPages) {
                empty.style.display = 'none';
                main.classList.remove('hidden');
                grid.classList.remove('hidden');
                info.classList.remove('hidden');
                info.classList.add('flex');
                addLabel.innerText = "新增檔案";
                exportGrp.classList.remove('hidden');
                settGrp.classList.remove('hidden');
                title.classList.add('hidden');
                document.getElementById('pageCountDisplay').innerText = `${pages.length} 頁`;
            } else {
                empty.style.display = 'flex';
                main.classList.add('hidden');
                grid.classList.add('hidden');
                info.classList.add('hidden');
                info.classList.remove('flex');
                addLabel.innerText = "開啟 PDF";
                exportGrp.classList.add('hidden');
                settGrp.classList.add('hidden');
                title.classList.remove('hidden');
            }
            
            document.getElementById('selectionBadge').innerText = `${selectedIds.size} 選取`;
            document.getElementById('statusBadges').innerText = `${selectedIds.size} 選取`;

            if (selectedIds.size > 0) {
                floatBar.classList.remove('hidden', 'opacity-0');
                floatBar.classList.add('flex', 'opacity-100');
            } else {
                floatBar.classList.add('hidden', 'opacity-0');
                floatBar.classList.remove('flex', 'opacity-100');
            }
            
            const pasteBtn = document.getElementById('pasteBtn');
            pasteBtn.disabled = clipboard.length === 0;
        }

        function handleKeys(e) {
            if (document.getElementById('gridWrapper').classList.contains('hidden')) return;
            if (e.target.tagName === 'INPUT') return;
            const isCmd = e.ctrlKey || e.metaKey;
            if (isCmd && e.key === 'z') { e.preventDefault(); undo(); }
            if (isCmd && e.key === 'y') { e.preventDefault(); redo(); }
            if (isCmd && e.key === 'a') { e.preventDefault(); selectAll(); }
            if (isCmd && e.key === 'c') { e.preventDefault(); copySelected(); }
            if (isCmd && e.key === 'v') { e.preventDefault(); pastePages(); }
            if (e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); deleteSelected(); }
            if (e.key === 'r') { e.preventDefault(); rotateSelected(90); }
            if (e.key === 'Escape') deselectAll();
        }

        function showLoading(s, t) { 
            document.getElementById('loadingModal').classList.toggle('hidden', !s); 
            if (t) document.getElementById('loadingText').textContent = t; 
        }
        
        function showToast(m, err) { 
            const t = document.getElementById('toast'); 
            t.innerText = m; 
            t.classList.remove('translate-y-4', 'opacity-0'); 
            if(err) t.classList.add('bg-red-600'); 
            else t.classList.remove('bg-red-600');
            setTimeout(() => t.classList.add('translate-y-4', 'opacity-0'), 2000);
        }
        
        function toggleModal(id) { 
            document.getElementById(id).classList.toggle('hidden'); 
        }
        
        function handleBackgroundClick(e) { 
            if(e.target.id === 'gridWrapper' || e.target.id === 'gridContainer') deselectAll(); 
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemDark)) { 
                document.documentElement.classList.add('dark'); 
            } else { 
                document.documentElement.classList.remove('dark'); 
            }
            updateZoomIndicators(parseInt(zoomSlider.value));
        }
        
        function toggleDarkMode() { 
            const isDark = document.documentElement.classList.toggle('dark'); 
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateZoomIndicators(parseInt(zoomSlider.value));
        }

        function setPagePos(p) { 
            document.querySelectorAll('.pn-btn').forEach(b => {
                if(b.dataset.pos === p) { 
                    b.classList.add('bg-indigo-50', 'border-indigo-500', 'text-indigo-600'); 
                } else { 
                    b.classList.remove('bg-indigo-50', 'border-indigo-500', 'text-indigo-600'); 
                }
            });
        }
        
        function setPageSettings(save) {
            if(save) {
                const active = document.querySelector('.pn-btn.bg-indigo-50');
                pgNumConfig = { 
                    pos: active ? active.dataset.pos : 'bottom-center', 
                    start: parseInt(document.getElementById('pnStart').value) || 1, 
                    size: 12 
                };
                showToast("頁碼已設定");
            } else { 
                pgNumConfig = null; 
                showToast("頁碼已移除"); 
            }
            toggleModal('pageNumberModal');
        }
        
        function saveMeta() {
            metaConfig = { 
                title: document.getElementById('metaTitle').value, 
                author: document.getElementById('metaAuthor').value 
            };
            toggleModal('metadataModal'); 
            showToast("元數據已設定");
        }
        
        function saveWatermark(save) {
            if(save) {
                wmConfig = { 
                    text: document.getElementById('wmText').value, 
                    color: document.getElementById('wmColor').value, 
                    opacity: parseFloat(document.getElementById('wmOpacity').value) 
                };
                if(!wmConfig.text) { wmConfig = null; } 
                showToast("浮水印已設定");
            } else { 
                wmConfig = null; 
                showToast("浮水印已移除"); 
            }
            toggleModal('watermarkModal');
        }

        // ✅ 初始化 Sortable
        function renderGrid(forceUpdate = false) {
            const container = gridContainer;
            if (!forceUpdate && container.children.length === pages.length) {
                updateAllPageNumbers();
                return;
            }
            
            container.innerHTML = '';
            pages.forEach((p, i) => {
                const card = createPageCard(p, i);
                container.appendChild(card);
                if (p.type !== 'blank') {
                    setTimeout(() => renderThumbnail(p), 10);
                }
            });
            
            initSortable();
            updateAllPageNumbers();
        }
    </script>
</body>
</html>
