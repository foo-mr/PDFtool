<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Organizer Pro - 專業頁面管理工具</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#4f46e5', // Indigo 600
                        brandHover: '#4338ca',
                        surface: '#f8fafc'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f1f5f9; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Grid Item Styles */
        .page-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .page-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .page-card.selected { ring: 2px solid #4f46e5; background-color: #eef2ff; transform: scale(1.02); z-index: 10; }
        
        /* Sortable Styles */
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; border: 2px dashed #94a3b8; }
        .sortable-drag { cursor: grabbing; opacity: 1; background: white; transform: scale(1.05) rotate(2deg); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); z-index: 50; }

        /* Loader */
        .loader { border-top-color: #4f46e5; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Toolbar Animation */
        .toolbar-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shadow-sm z-20 flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-brand text-white p-2 rounded-lg shadow-sm">
                <i class="fa-solid fa-layer-group"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 leading-tight">PDF Organizer Pro</h1>
                <p class="text-[10px] text-slate-500 font-medium tracking-wide">SECURE CLIENT-SIDE PROCESSING</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div id="fileInfo" class="hidden items-center gap-3 px-4 py-1.5 bg-slate-50 rounded-full border border-slate-200 text-sm">
                <i class="fa-regular fa-file-pdf text-red-500"></i>
                <span id="fileNameDisplay" class="font-medium text-slate-700 truncate max-w-[200px]">filename.pdf</span>
                <span id="pageCountDisplay" class="text-slate-400 text-xs border-l border-slate-200 pl-3">0 頁</span>
            </div>

            <button onclick="document.getElementById('fileInput').click()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-folder-open text-brand"></i> 開啟文件
            </button>
            <input type="file" id="fileInput" accept=".pdf" class="hidden" onchange="handleFileUpload(event)">

            <div class="h-8 w-px bg-slate-200 mx-2"></div>

            <div class="relative group">
                <button id="exportBtn" disabled class="bg-brand hover:bg-brandHover disabled:bg-slate-300 disabled:cursor-not-allowed text-white px-5 py-2 rounded-lg text-sm font-medium transition shadow-md shadow-indigo-500/20 flex items-center gap-2">
                    <span>匯出檔案</span>
                    <i class="fa-solid fa-chevron-down text-xs opacity-80"></i>
                </button>
                <!-- Dropdown Menu -->
                <div class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right z-50">
                    <div class="p-1">
                        <button onclick="exportFile('pdf')" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-3">
                            <i class="fa-solid fa-file-pdf text-red-500 text-lg w-6"></i>
                            <div>
                                <div class="font-medium">PDF 文件</div>
                                <div class="text-xs text-slate-400">合併所有頁面</div>
                            </div>
                        </button>
                        <button onclick="exportFile('zip')" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-3">
                            <i class="fa-solid fa-file-zipper text-yellow-500 text-lg w-6"></i>
                            <div>
                                <div class="font-medium">獨立 PDF (ZIP)</div>
                                <div class="text-xs text-slate-400">每頁存為單獨檔案</div>
                            </div>
                        </button>
                        <button onclick="exportFile('images')" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-3">
                            <i class="fa-regular fa-image text-blue-500 text-lg w-6"></i>
                            <div>
                                <div class="font-medium">圖片序列 (JPG)</div>
                                <div class="text-xs text-slate-400">高解析度圖片</div>
                            </div>
                        </button>
                        <button onclick="exportFile('text')" class="w-full text-left px-4 py-2.5 text-sm text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-3">
                            <i class="fa-solid fa-align-left text-slate-500 text-lg w-6"></i>
                            <div>
                                <div class="font-medium">純文字 (TXT)</div>
                                <div class="text-xs text-slate-400">提取頁面內容</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Workspace -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-surface" onclick="handleBackgroundClick(event)">
        
        <!-- Empty State -->
        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center z-0">
            <div class="bg-white p-10 rounded-3xl shadow-sm border border-slate-200 text-center max-w-md mx-6 transition hover:shadow-md">
                <div class="w-20 h-20 bg-indigo-50 text-brand rounded-2xl flex items-center justify-center mx-auto mb-6 text-3xl shadow-inner">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-3">拖放或開啟 PDF</h2>
                <p class="text-slate-500 mb-8 leading-relaxed">開始整理您的文件。支援重新排序、旋轉、刪除頁面以及插入空白頁。</p>
                <button onclick="document.getElementById('fileInput').click()" class="bg-brand hover:bg-brandHover text-white px-8 py-3 rounded-xl font-medium shadow-lg shadow-indigo-500/30 transition transform hover:-translate-y-0.5">
                    選擇檔案
                </button>
                <div class="mt-6 flex justify-center gap-6 text-xs text-slate-400 font-medium">
                    <span class="flex items-center gap-1"><i class="fa-solid fa-lock"></i> 本地加密</span>
                    <span class="flex items-center gap-1"><i class="fa-solid fa-bolt"></i> 極速處理</span>
                </div>
            </div>
        </div>

        <!-- Controls Bar (Top) -->
        <div id="topBar" class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-6 hidden opacity-0 transition-opacity duration-300 z-10">
            <div class="flex items-center gap-4 text-sm">
                <button onclick="selectAll()" class="text-slate-600 hover:text-brand font-medium transition">全選</button>
                <span class="text-slate-300">|</span>
                <button onclick="deselectAll()" class="text-slate-600 hover:text-brand font-medium transition">取消選取</button>
                <span class="bg-indigo-50 text-brand px-2 py-0.5 rounded text-xs font-bold ml-2" id="selectionBadge">0 選取</span>
            </div>
            
            <div class="flex items-center gap-3">
                <span class="text-xs text-slate-400 mr-2"><i class="fa-solid fa-magnifying-glass"></i></span>
                <input type="range" min="100" max="350" value="180" class="w-32 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-brand" oninput="updateZoom(this.value)">
            </div>
        </div>

        <!-- Grid Container -->
        <div id="gridWrapper" class="flex-1 overflow-y-auto p-8 hidden scroll-smooth">
            <div id="gridContainer" class="grid gap-6 pb-32 transition-all duration-300 mx-auto" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));">
                <!-- Pages injected here -->
            </div>
        </div>

        <!-- Floating Action Bar (Bottom) -->
        <div id="floatingToolbar" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900/90 backdrop-blur-md text-white px-2 py-2 rounded-2xl shadow-2xl border border-white/10 flex items-center gap-1 z-30 hidden toolbar-enter">
            
            <div class="flex items-center gap-1 px-2 border-r border-white/20">
                <button onclick="rotateSelected(-90)" class="p-2.5 hover:bg-white/20 rounded-xl transition tooltip-trigger relative group" title="向左旋轉">
                    <i class="fa-solid fa-rotate-left"></i>
                    <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">向左旋轉</span>
                </button>
                <button onclick="rotateSelected(90)" class="p-2.5 hover:bg-white/20 rounded-xl transition group relative" title="向右旋轉">
                    <i class="fa-solid fa-rotate-right"></i>
                    <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">向右旋轉</span>
                </button>
            </div>

            <div class="flex items-center gap-1 px-2 border-r border-white/20">
                <button onclick="addBlankPage()" class="p-2.5 hover:bg-white/20 rounded-xl transition group relative" title="插入空白頁">
                    <i class="fa-regular fa-square-plus"></i>
                    <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">插入空白頁</span>
                </button>
                <button onclick="copySelected()" class="p-2.5 hover:bg-white/20 rounded-xl transition group relative" title="複製">
                    <i class="fa-regular fa-copy"></i>
                    <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">複製</span>
                </button>
                <button id="pasteBtn" disabled onclick="pastePages()" class="p-2.5 hover:bg-white/20 disabled:opacity-30 disabled:hover:bg-transparent rounded-xl transition group relative" title="貼上">
                    <i class="fa-regular fa-paste"></i>
                    <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-black text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">貼上</span>
                </button>
            </div>

            <div class="px-2">
                <button onclick="deleteSelected()" class="p-2.5 hover:bg-red-500/80 text-red-400 hover:text-white rounded-xl transition group relative" title="刪除">
                    <i class="fa-solid fa-trash-can"></i>
                    <span class="absolute -top-10 left-1/2 -translate-x-1/2 bg-red-600 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none">刪除頁面</span>
                </button>
            </div>
        </div>

    </main>

    <!-- Loading Overlay -->
    <div id="loadingModal" class="fixed inset-0 bg-white/90 z-50 hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12 mb-4"></div>
        <h2 class="text-xl font-bold text-slate-800 mb-2" id="loadingTitle">處理中</h2>
        <p class="text-slate-500 text-sm" id="loadingText">請稍候...</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg text-sm opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-2">
        <i class="fa-solid fa-circle-check text-green-400"></i> <span id="toastMsg">Action Completed</span>
    </div>

    <script>
        // --- Application State ---
        let pdfDoc = null;
        let pdfBytes = null;
        let fileName = "document";
        
        // Core Data Model: Array of Page Objects
        // { id: string, type: 'original'|'blank', originalIndex: number (0-based), rotation: number (0,90,180,270) }
        let pages = []; 
        let selectedIds = new Set();
        let clipboard = []; // Array of Page Objects
        let sortable = null;
        let currentZoom = 180;

        // --- UI Logic ---

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            const icon = toast.querySelector('i');
            document.getElementById('toastMsg').innerText = msg;
            
            toast.className = `fixed bottom-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-xl text-sm opacity-100 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-3 font-medium ${isError ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'}`;
            icon.className = isError ? 'fa-solid fa-circle-exclamation' : 'fa-solid fa-circle-check text-green-400';
            
            setTimeout(() => { toast.style.opacity = '0'; }, 2500);
        }

        function showLoading(show, title = "處理中", text = "請稍候...") {
            const modal = document.getElementById('loadingModal');
            if (show) {
                document.getElementById('loadingTitle').innerText = title;
                document.getElementById('loadingText').innerText = text;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function updateUI() {
            const hasPages = pages.length > 0;
            const hasSelection = selectedIds.size > 0;

            // Layout Visibility
            document.getElementById('emptyState').style.display = hasPages ? 'none' : 'flex';
            document.getElementById('topBar').classList.toggle('hidden', !hasPages);
            document.getElementById('gridWrapper').classList.toggle('hidden', !hasPages);
            
            // Fade in effect
            if(hasPages) setTimeout(() => document.getElementById('topBar').classList.remove('opacity-0'), 50);
            
            // File Info
            if (hasPages) {
                document.getElementById('fileInfo').classList.replace('hidden', 'flex');
                document.getElementById('pageCountDisplay').innerText = `${pages.length} 頁`;
                document.getElementById('fileNameDisplay').innerText = fileName;
                document.getElementById('exportBtn').disabled = false;
            }

            // Selection Stats & Toolbar
            document.getElementById('selectionBadge').innerText = `${selectedIds.size} 選取`;
            const toolbar = document.getElementById('floatingToolbar');
            
            if (hasSelection) {
                toolbar.classList.remove('hidden');
            } else {
                // Only hide toolbar if clipboard is empty too, otherwise keep it for paste
                if(clipboard.length === 0) toolbar.classList.add('hidden');
                else toolbar.classList.remove('hidden');
            }

            // Paste Button State
            document.getElementById('pasteBtn').disabled = clipboard.length === 0;
        }

        function updateZoom(val) {
            currentZoom = val;
            document.getElementById('gridContainer').style.gridTemplateColumns = `repeat(auto-fill, minmax(${val}px, 1fr))`;
        }

        // --- Event Handlers ---

        // Handle clicking on gray background to deselect
        function handleBackgroundClick(e) {
            if (e.target.id === 'gridWrapper' || e.target.id === 'gridContainer') {
                deselectAll();
            }
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('gridWrapper').classList.contains('hidden')) return;
            
            const isCmd = e.ctrlKey || e.metaKey;
            
            if (isCmd && e.key === 'a') {
                e.preventDefault();
                selectAll();
            }
            if ((e.key === 'Delete' || e.key === 'Backspace') && selectedIds.size > 0) {
                e.preventDefault();
                deleteSelected();
            }
            if (isCmd && e.key === 'c') {
                e.preventDefault();
                copySelected();
            }
            if (isCmd && e.key === 'v') {
                e.preventDefault();
                pastePages();
            }
        });

        // --- File Loading ---

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true, "讀取檔案", "正在解析 PDF 結構...");
            fileName = file.name.replace('.pdf', '');

            try {
                const arrayBuffer = await file.arrayBuffer();
                // CRITICAL FIX: Copy buffer because pdfjsLib transfers ownership to worker, detaching the original
                pdfBytes = arrayBuffer.slice(0); 

                const loadingTask = pdfjsLib.getDocument(arrayBuffer);
                pdfDoc = await loadingTask.promise;

                // Init Pages State
                pages = [];
                for (let i = 0; i < pdfDoc.numPages; i++) {
                    pages.push({
                        id: crypto.randomUUID(),
                        type: 'original',
                        originalIndex: i, // 0-based for pdf.js/pdf-lib
                        rotation: 0
                    });
                }

                // Reset state
                selectedIds.clear();
                clipboard = [];
                
                // Render
                await renderGrid();
                updateUI();
                showLoading(false);
                showToast(`成功載入 ${pdfDoc.numPages} 頁`);

            } catch (error) {
                console.error(error);
                showLoading(false);
                showToast("無法讀取檔案，請確認是否為有效 PDF", true);
            }
        }

        // --- Grid Rendering ---

        async function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';

            // Batch render loop
            for (let i = 0; i < pages.length; i++) {
                const page = pages[i];
                const isSelected = selectedIds.has(page.id);

                const div = document.createElement('div');
                div.className = `page-card bg-white rounded-xl p-3 border-2 cursor-pointer relative group ${isSelected ? 'selected border-brand' : 'border-transparent hover:border-indigo-200'}`;
                div.dataset.id = page.id;
                div.onclick = (e) => toggleSelection(page.id, e.ctrlKey || e.metaKey || e.shiftKey);

                // Inner HTML
                div.innerHTML = `
                    <div class="relative aspect-[1/1.4] bg-slate-100 rounded-lg overflow-hidden mb-3 shadow-inner flex items-center justify-center">
                        <div class="canvas-wrapper w-full h-full flex items-center justify-center transition-transform duration-300" style="transform: rotate(${page.rotation}deg);">
                            ${page.type === 'blank' 
                                ? '<div class="text-slate-300 text-sm font-medium">Blank Page</div>' 
                                : '<canvas class="max-w-full max-h-full object-contain"></canvas>'
                            }
                        </div>
                        <!-- Overlay Actions -->
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                            <button onclick="event.stopPropagation(); rotateSingle('${page.id}', 90)" class="bg-white/90 text-slate-600 hover:text-brand p-1.5 rounded-md shadow-sm backdrop-blur-sm"><i class="fa-solid fa-rotate-right"></i></button>
                        </div>
                        <!-- Checkmark -->
                        <div class="absolute top-2 left-2 w-6 h-6 rounded-full border-2 ${isSelected ? 'bg-brand border-brand' : 'bg-white/80 border-slate-300'} flex items-center justify-center transition-colors shadow-sm z-10">
                            <i class="fa-solid fa-check text-white text-xs ${isSelected ? 'opacity-100' : 'opacity-0'}"></i>
                        </div>
                    </div>
                    <div class="flex justify-between items-center px-1">
                        <span class="text-xs font-bold text-slate-700">Page ${i + 1}</span>
                        <span class="text-[10px] text-slate-400 font-medium bg-slate-100 px-1.5 py-0.5 rounded">${page.type === 'original' ? '原稿' : '空白'}</span>
                    </div>
                `;

                container.appendChild(div);

                // Lazy render canvas
                if (page.type === 'original') {
                    renderThumbnail(page, div.querySelector('canvas'));
                }
            }

            // Init Sortable
            if (sortable) sortable.destroy();
            sortable = new Sortable(container, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                delay: 100,
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const item = pages.splice(evt.oldIndex, 1)[0];
                    pages.splice(evt.newIndex, 0, item);
                    // Update UI page numbers without full re-render if possible, but here we re-render for simplicity and index consistency
                    setTimeout(renderGrid, 50); 
                }
            });
        }

        async function renderThumbnail(pageObj, canvasEl) {
            if (!pdfDoc) return;
            try {
                const page = await pdfDoc.getPage(pageObj.originalIndex + 1); // PDF.js is 1-based
                const viewport = page.getViewport({ scale: 0.4 }); // Low res for grid
                
                canvasEl.height = viewport.height;
                canvasEl.width = viewport.width;
                
                const ctx = canvasEl.getContext('2d');
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            } catch (e) {
                console.error("Thumb error", e);
            }
        }

        // --- Page Manipulation Logic ---

        function toggleSelection(id, multi) {
            if (!multi) selectedIds.clear();
            if (selectedIds.has(id)) selectedIds.delete(id);
            else selectedIds.add(id);
            
            updateVisualSelection();
            updateUI();
        }

        function selectAll() {
            pages.forEach(p => selectedIds.add(p.id));
            updateVisualSelection();
            updateUI();
        }

        function deselectAll() {
            selectedIds.clear();
            updateVisualSelection();
            updateUI();
        }

        function updateVisualSelection() {
            const cards = document.querySelectorAll('.page-card');
            cards.forEach(card => {
                const id = card.dataset.id;
                const isSelected = selectedIds.has(id);
                const checkmark = card.querySelector('.fa-check');
                const checkCircle = checkmark.parentElement;

                if (isSelected) {
                    card.classList.add('selected', 'border-brand');
                    card.classList.remove('border-transparent');
                    checkCircle.className = "absolute top-2 left-2 w-6 h-6 rounded-full border-2 bg-brand border-brand flex items-center justify-center transition-colors shadow-sm z-10";
                    checkmark.classList.remove('opacity-0');
                } else {
                    card.classList.remove('selected', 'border-brand');
                    card.classList.add('border-transparent');
                    checkCircle.className = "absolute top-2 left-2 w-6 h-6 rounded-full border-2 bg-white/80 border-slate-300 flex items-center justify-center transition-colors shadow-sm z-10";
                    checkmark.classList.add('opacity-0');
                }
            });
        }

        function rotateSingle(id, angle) {
            const page = pages.find(p => p.id === id);
            if (page) {
                page.rotation = (page.rotation + angle) % 360;
                if (page.rotation < 0) page.rotation += 360;
                
                // Update visual directly
                const card = document.querySelector(`.page-card[data-id="${id}"]`);
                const wrapper = card.querySelector('.canvas-wrapper');
                wrapper.style.transform = `rotate(${page.rotation}deg)`;
            }
        }

        function rotateSelected(angle) {
            if (selectedIds.size === 0) return;
            pages.forEach(p => {
                if (selectedIds.has(p.id)) {
                    p.rotation = (p.rotation + angle) % 360;
                    if (p.rotation < 0) p.rotation += 360;
                    
                    const card = document.querySelector(`.page-card[data-id="${p.id}"]`);
                    if(card) {
                        const wrapper = card.querySelector('.canvas-wrapper');
                        wrapper.style.transform = `rotate(${p.rotation}deg)`;
                    }
                }
            });
        }

        function deleteSelected() {
            if (selectedIds.size === 0) return;
            
            pages = pages.filter(p => !selectedIds.has(p.id));
            selectedIds.clear();
            renderGrid();
            updateUI();
            showToast("已刪除頁面");
        }

        function addBlankPage() {
            // Add after the last selected item, or at end
            let insertIndex = pages.length;
            if (selectedIds.size > 0) {
                // Find index of last selected item
                let maxIdx = -1;
                pages.forEach((p, idx) => { if (selectedIds.has(p.id)) maxIdx = idx; });
                if (maxIdx !== -1) insertIndex = maxIdx + 1;
            }

            const newPage = {
                id: crypto.randomUUID(),
                type: 'blank',
                originalIndex: -1,
                rotation: 0
            };
            
            pages.splice(insertIndex, 0, newPage);
            renderGrid();
            updateUI();
            
            // Scroll to new page
            setTimeout(() => {
                const el = document.querySelector(`.page-card[data-id="${newPage.id}"]`);
                if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'});
            }, 100);
            
            showToast("已插入空白頁");
        }

        function copySelected() {
            if (selectedIds.size === 0) return;
            // Clone deep to avoid reference issues
            clipboard = pages
                .filter(p => selectedIds.has(p.id))
                .map(p => ({...p})); // shallow copy is enough for primitives
            
            updateUI();
            showToast(`已複製 ${clipboard.length} 個頁面`);
        }

        function pastePages() {
            if (clipboard.length === 0) return;
            
            let insertIndex = pages.length;
            if (selectedIds.size > 0) {
                let maxIdx = -1;
                pages.forEach((p, idx) => { if (selectedIds.has(p.id)) maxIdx = idx; });
                if (maxIdx !== -1) insertIndex = maxIdx + 1;
            }

            // Generate new IDs for pasted items
            const newItems = clipboard.map(p => ({
                ...p,
                id: crypto.randomUUID()
            }));

            pages.splice(insertIndex, 0, ...newItems);
            
            // Select newly pasted items
            selectedIds.clear();
            newItems.forEach(p => selectedIds.add(p.id));
            
            renderGrid();
            updateUI();
            showToast(`已貼上 ${newItems.length} 個頁面`);
        }

        // --- Export Logic (Smart Engine) ---

        async function exportFile(format) {
            if (pages.length === 0) return;
            showLoading(true, "正在導出", `正在生成 ${format.toUpperCase()} 文件...`);

            try {
                const { PDFDocument, degrees, PageSizes } = PDFLib;
                const srcDoc = await PDFDocument.load(pdfBytes);
                
                if (format === 'pdf') {
                    // Merge into one PDF
                    const newDoc = await PDFDocument.create();
                    
                    for (const p of pages) {
                        if (p.type === 'original') {
                            const [copiedPage] = await newDoc.copyPages(srcDoc, [p.originalIndex]);
                            // Apply rotation (cumulative with original rotation if needed, but setRotation replaces it usually)
                            // To be safe, we add to existing rotation if we wanted to preserve relative, but simpler is to set absolute if visual is absolute.
                            // pdf-lib setRotation adds to the page's existing rotation if we aren't careful? No, it sets the /Rotate entry.
                            // However, our 'p.rotation' is visual rotation relative to upright.
                            // Let's add our delta to the page's existing rotation.
                            const existingRotation = copiedPage.getRotation().angle;
                            copiedPage.setRotation(degrees(existingRotation + p.rotation));
                            newDoc.addPage(copiedPage);
                        } else {
                            const page = newDoc.addPage(PageSizes.A4);
                            // Blank page
                        }
                    }
                    
                    const data = await newDoc.save();
                    downloadBlob(data, `${fileName}_organized.pdf`, 'application/pdf');

                } else if (format === 'zip' || format === 'images' || format === 'text') {
                    const zip = new JSZip();
                    
                    // Loop pages logic
                    for (let i = 0; i < pages.length; i++) {
                        const p = pages[i];
                        const num = i + 1;

                        if (format === 'zip') {
                            if (p.type === 'original') {
                                const subDoc = await PDFDocument.create();
                                const [copiedPage] = await subDoc.copyPages(srcDoc, [p.originalIndex]);
                                const existingRotation = copiedPage.getRotation().angle;
                                copiedPage.setRotation(degrees(existingRotation + p.rotation));
                                subDoc.addPage(copiedPage);
                                const data = await subDoc.save();
                                zip.file(`page_${num}.pdf`, data);
                            } else {
                                // Blank PDF
                                const subDoc = await PDFDocument.create();
                                subDoc.addPage(PageSizes.A4);
                                const data = await subDoc.save();
                                zip.file(`page_${num}_blank.pdf`, data);
                            }
                        }
                        else if (format === 'images') {
                            if (p.type === 'original') {
                                // Render using PDF.js
                                const pdfPage = await pdfDoc.getPage(p.originalIndex + 1);
                                const viewport = pdfPage.getViewport({ scale: 2.0, rotation: p.rotation });
                                const cvs = document.createElement('canvas');
                                cvs.width = viewport.width;
                                cvs.height = viewport.height;
                                await pdfPage.render({ canvasContext: cvs.getContext('2d'), viewport: viewport }).promise;
                                const imgData = cvs.toDataURL('image/jpeg', 0.9).split(',')[1];
                                zip.file(`page_${num}.jpg`, imgData, {base64: true});
                            } else {
                                // Blank Image (white)
                                const cvs = document.createElement('canvas');
                                cvs.width = 595 * 2; cvs.height = 842 * 2; // A4 approx @ 2x
                                const ctx = cvs.getContext('2d');
                                ctx.fillStyle = "white";
                                ctx.fillRect(0, 0, cvs.width, cvs.height);
                                const imgData = cvs.toDataURL('image/jpeg', 0.9).split(',')[1];
                                zip.file(`page_${num}_blank.jpg`, imgData, {base64: true});
                            }
                        }
                        else if (format === 'text') {
                            if (p.type === 'original') {
                                const pdfPage = await pdfDoc.getPage(p.originalIndex + 1);
                                const textContent = await pdfPage.getTextContent();
                                const str = textContent.items.map(item => item.str).join(' ');
                                zip.file(`page_${num}.txt`, str);
                            } else {
                                zip.file(`page_${num}_blank.txt`, "");
                            }
                        }
                    }

                    const zipContent = await zip.generateAsync({ type: "blob" });
                    const ext = format === 'zip' ? 'zip' : 'zip';
                    downloadBlob(zipContent, `${fileName}_${format}.${ext}`, 'application/zip');
                }

                showLoading(false);
                showToast("導出成功！");

            } catch (e) {
                console.error(e);
                showLoading(false);
                showToast("導出失敗，請稍後再試", true);
            }
        }

        function downloadBlob(data, name, type) {
            const blob = new Blob([data], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>
