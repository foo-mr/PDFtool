<!DOCTYPE html>
<html lang="zh-TW" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Organizer - 混合工作台 v10.</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                extend: {
                    colors: {
                        brand: '#6366f1', brandHover: '#4f46e5',
                        surface: '#f8fafc', darkSurface: '#0f172a', darkCard: '#1e293b'
                    }
                }
            }
        }
    </script>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .page-card { transition: transform 0.2s, box-shadow 0.2s, ring 0.2s; }
        .page-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15); }
        .page-card.selected { ring: 2px solid #6366f1; transform: scale(1.02); z-index: 10; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        
        .loader { border-top-color: #6366f1; animation: spinner 0.8s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toolbar-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        #dropOverlay { backdrop-filter: blur(8px); transition: opacity 0.2s ease-in-out; }
        
        .filename-input { background: transparent; border: 1px solid transparent; border-radius: 4px; padding: 2px 6px; transition: all 0.2s; }
        .filename-input:hover { background-color: rgba(0,0,0,0.05); }
        .dark .filename-input:hover { background-color: rgba(255,255,255,0.1); }
        .filename-input:focus { border-color: #6366f1; background-color: white; color: #0f172a; outline: none; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        
        .sortable-ghost { opacity: 0.5; background: #6366f1/20; border: 2px dashed #6366f1; }
        .sortable-drag { background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    </style>
</head>
<body class="h-screen flex flex-col text-slate-700 bg-slate-50 dark:bg-darkSurface dark:text-slate-300 transition-colors duration-300">

    <!-- Drop Zone -->
    <div id="dropOverlay" class="fixed inset-0 z-[100] bg-brand/90 dark:bg-indigo-950/90 hidden flex-col items-center justify-center opacity-0 pointer-events-none">
        <div class="bg-white dark:bg-slate-800 p-12 rounded-3xl shadow-2xl text-center transform scale-110 border border-white/20">
            <i class="fa-solid fa-cloud-arrow-up text-7xl text-brand dark:text-indigo-400 mb-6 animate-bounce"></i>
            <h2 class="text-3xl font-bold text-slate-800 dark:text-white">釋放文件以加入</h2>
            <p class="text-slate-500 dark:text-slate-400 mt-2 font-medium">支援 PDF、JPG、PNG</p>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200/60 dark:border-slate-800/60 h-16 flex items-center justify-between px-6 z-20 flex-shrink-0 sticky top-0">
        <div class="flex items-center gap-4 flex-1 min-w-0">
            <div class="flex items-center gap-3 group cursor-pointer" onclick="location.reload()">
                <div class="bg-gradient-to-br from-brand to-indigo-600 text-white p-2 rounded-xl shadow-lg">
                    <i class="fa-solid fa-layer-group text-lg"></i>
                </div>
                <div id="appTitle">
                    <h1 class="font-bold text-lg tracking-tight text-slate-800 dark:text-white">PDF Organizer <span class="text-[10px] bg-indigo-100 text-brand px-1.5 py-0.5 rounded-md ml-1">v10.1</span></h1>
                </div>
            </div>

            <div id="fileInfo" class="hidden items-center gap-3 pl-4 border-l border-slate-200 dark:border-slate-700">
                <div class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg px-3 py-1.5 border border-slate-200 dark:border-slate-700">
                    <i class="fa-regular fa-file-pdf text-red-500 mr-2"></i>
                    <input type="text" id="fileNameInput" class="filename-input font-medium text-sm w-48 truncate text-slate-700 dark:text-slate-200 placeholder-slate-400" value="merged_document" onblur="fileName = this.value">
                </div>
                <span id="pageCountDisplay" class="text-xs font-medium text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">0 頁</span>
                <button onclick="closeAllFiles()" class="w-7 h-7 flex items-center justify-center rounded-full text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition ml-1" title="關閉所有"><i class="fa-solid fa-times"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="toggleDarkMode()" class="w-9 h-9 flex items-center justify-center rounded-full text-slate-500 hover:bg-slate-100 hover:text-brand transition"><i class="fa-solid fa-moon dark:hidden"></i><i class="fa-solid fa-sun hidden dark:inline"></i></button>
            
            <div id="settingsBtnGroup" class="hidden">
                <div class="relative group">
                    <button class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium text-slate-600 hover:bg-slate-100 hover:text-brand dark:text-slate-300 dark:hover:bg-slate-800 transition border border-transparent hover:border-slate-200">
                        <i class="fa-solid fa-sliders"></i> <span>設定</span>
                    </button>
                    <div class="absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 hidden group-hover:block z-50">
                        <div class="py-1.5">
                            <button onclick="toggleModal('pageNumberModal')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3"><i class="fa-solid fa-list-ol w-4"></i> 插入頁碼</button>
                            <button onclick="toggleModal('metadataModal')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3"><i class="fa-solid fa-tags w-4"></i> 元數據</button>
                            <button onclick="toggleModal('watermarkModal')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center gap-3"><i class="fa-solid fa-stamp w-4"></i> 浮水印</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>

            <button id="addFileBtn" onclick="document.getElementById('fileInput').click()" class="bg-slate-900 hover:bg-slate-800 dark:bg-white dark:hover:bg-slate-200 text-white dark:text-slate-900 px-4 py-2 rounded-lg text-sm font-semibold transition shadow-md flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> <span id="addFileLabel">開啟 PDF</span>
            </button>
            <input type="file" id="fileInput" accept=".pdf,image/jpeg,image/png" multiple class="hidden" onchange="handleFiles(this.files)">

            <!-- 修复后的导出按钮组 -->
            <div id="exportBtnGroup" class="relative hidden">
                <button class="bg-brand hover:bg-brandHover text-white px-5 py-2 rounded-lg text-sm font-semibold transition shadow-md flex items-center gap-2" onclick="toggleExportDropdown()">
                    <span>匯出</span><i class="fa-solid fa-chevron-down text-xs opacity-70 ml-1"></i>
                </button>
                <div id="exportDropdown" class="absolute right-0 mt-3 w-60 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 hidden z-50">
                    <div class="p-1.5">
                        <button onclick="exportFile('pdf'); toggleExportDropdown(false)" class="w-full text-left px-3 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg flex items-center gap-3"><i class="fa-solid fa-file-pdf text-red-500"></i> PDF 文件</button>
                        <button onclick="exportFile('zip'); toggleExportDropdown(false)" class="w-full text-left px-3 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg flex items-center gap-3"><i class="fa-solid fa-file-zipper text-yellow-500"></i> 獨立 PDF (ZIP)</button>
                        <button onclick="exportFile('images'); toggleExportDropdown(false)" class="w-full text-left px-3 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg flex items-center gap-3"><i class="fa-regular fa-image text-blue-500"></i> 圖片序列 (JPG)</button>
                        <button onclick="exportFile('text'); toggleExportDropdown(false)" class="w-full text-left px-3 py-2.5 text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg flex items-center gap-3"><i class="fa-solid fa-align-left text-slate-500"></i> 純文字 (TXT)</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden" id="mainArea">
        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center z-0 px-4">
            <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm p-12 rounded-3xl border border-slate-200 dark:border-slate-700 text-center max-w-lg w-full transition-all hover:shadow-xl">
                <div class="w-24 h-24 bg-white dark:bg-slate-700 text-brand rounded-3xl flex items-center justify-center mx-auto mb-8 text-4xl shadow-soft"><i class="fa-solid fa-folder-open"></i></div>
                <h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-4">混合工作台</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-10 leading-relaxed">支援多個 PDF 與圖片混合編輯。<br>拖放檔案至此，或點擊下方按鈕。</p>
                <button onclick="document.getElementById('fileInput').click()" class="bg-brand hover:bg-brandHover text-white px-10 py-4 rounded-xl font-semibold shadow-lg transition transform hover:-translate-y-1 flex justify-center items-center gap-3 mx-auto"><i class="fa-solid fa-plus"></i> 開始新增檔案</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div id="topBar" class="h-14 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-b border-slate-200/60 dark:border-slate-800/60 flex items-center justify-between px-6 hidden z-10">
            <div class="flex items-center gap-4 text-sm">
                <div class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg p-1 mr-2 shadow-sm">
                    <button onclick="undo()" id="btnUndo" disabled class="w-8 h-8 flex items-center justify-center rounded hover:bg-white dark:hover:bg-slate-700 disabled:opacity-30 transition"><i class="fa-solid fa-arrow-rotate-left"></i></button>
                    <button onclick="redo()" id="btnRedo" disabled class="w-8 h-8 flex items-center justify-center rounded hover:bg-white dark:hover:bg-slate-700 disabled:opacity-30 transition"><i class="fa-solid fa-arrow-rotate-right"></i></button>
                </div>
                <div class="h-4 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                <button onclick="selectAll()" class="hover:text-brand transition px-2 py-1 rounded hover:bg-slate-100">全選</button>
                <button onclick="deselectAll()" class="hover:text-brand transition px-2 py-1 rounded hover:bg-slate-100">取消</button>
                <span class="bg-indigo-50 dark:bg-indigo-900/30 text-brand px-3 py-1 rounded-full text-xs font-bold ml-2" id="selectionBadge">0 選取</span>
                <div class="flex items-center gap-1 ml-2 border-l border-slate-200 dark:border-slate-700 pl-3">
                    <button onclick="rotateAll(90)" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-brand transition" title="全部向右旋轉"><i class="fa-solid fa-rotate"></i></button>
                    <button onclick="reverseOrder()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-brand transition" title="反向排序"><i class="fa-solid fa-sort"></i></button>
                    <button onclick="resetPageOrder()" class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-red-500 transition" title="重置"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="statusBadges" class="flex gap-2"></div>
                <input type="range" min="100" max="350" value="180" class="w-24 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-brand" oninput="updateZoom(this.value)">
            </div>
        </div>

        <!-- Grid -->
        <div id="gridWrapper" class="flex-1 overflow-y-auto p-8 hidden scroll-smooth bg-slate-50/50 dark:bg-slate-950/50">
            <div id="gridContainer" class="grid gap-6 pb-32 transition-all duration-300 mx-auto" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));"></div>
        </div>

        <!-- Floating Bar -->
        <div id="floatingToolbar" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-900/90 dark:bg-white/90 backdrop-blur-md text-white dark:text-slate-800 px-3 py-2 rounded-2xl shadow-2xl border border-white/10 hidden animate-slide-up z-30">
            <div class="flex items-center gap-1 px-2 border-r border-white/20 dark:border-slate-300">
                <button onclick="rotateSelected(-90)" class="p-3 hover:bg-white/20 rounded-xl"><i class="fa-solid fa-rotate-left"></i></button>
                <button onclick="rotateSelected(90)" class="p-3 hover:bg-white/20 rounded-xl"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
            <div class="flex items-center gap-1 px-2 border-r border-white/20 dark:border-slate-300">
                <button onclick="addBlankPage()" class="p-3 hover:bg-white/20 rounded-xl"><i class="fa-regular fa-square-plus"></i></button>
                <button onclick="copySelected()" class="p-3 hover:bg-white/20 rounded-xl"><i class="fa-regular fa-copy"></i></button>
                <button id="pasteBtn" onclick="pastePages()" disabled class="p-3 hover:bg-white/20 disabled:opacity-30 rounded-xl"><i class="fa-regular fa-paste"></i></button>
            </div>
            <div class="px-2">
                <button onclick="deleteSelected()" class="p-3 hover:bg-red-500/80 hover:text-white text-red-400 dark:text-red-500 rounded-xl"><i class="fa-solid fa-trash-can"></i></button>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="pageNumberModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4">
            <h3 class="font-bold text-lg dark:text-white">頁碼設定</h3>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setPagePos('bottom-left')" class="pn-btn border p-2 rounded hover:bg-indigo-50 dark:text-white" data-pos="bottom-left">左下</button>
                <button onclick="setPagePos('bottom-center')" class="pn-btn border p-2 rounded bg-indigo-50 border-indigo-500 text-indigo-600" data-pos="bottom-center">置中</button>
                <button onclick="setPagePos('bottom-right')" class="pn-btn border p-2 rounded hover:bg-indigo-50 dark:text-white" data-pos="bottom-right">右下</button>
            </div>
            <input id="pnStart" type="number" value="1" class="w-full border rounded p-2 dark:bg-slate-900 dark:text-white" placeholder="起始頁碼">
            <div class="flex justify-end gap-2">
                <button onclick="setPageSettings(null)" class="px-4 py-2 text-red-500">清除</button>
                <button onclick="setPageSettings(true)" class="px-4 py-2 bg-brand text-white rounded">確認</button>
            </div>
            <button onclick="toggleModal('pageNumberModal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <div id="metadataModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4 relative">
            <h3 class="font-bold text-lg dark:text-white">元數據</h3>
            <input id="metaTitle" class="w-full border rounded p-2 dark:bg-slate-900 dark:text-white" placeholder="標題">
            <input id="metaAuthor" class="w-full border rounded p-2 dark:bg-slate-900 dark:text-white" placeholder="作者">
            <div class="flex justify-end"><button onclick="saveMeta()" class="px-4 py-2 bg-brand text-white rounded">儲存</button></div>
            <button onclick="toggleModal('metadataModal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <div id="watermarkModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md p-6 space-y-4 relative">
            <h3 class="font-bold text-lg dark:text-white">浮水印</h3>
            <input id="wmText" class="w-full border rounded p-2 dark:bg-slate-900 dark:text-white" placeholder="文字">
            <input id="wmColor" type="color" class="w-full h-10 rounded" value="#ff0000">
            <input id="wmOpacity" type="range" min="0.1" max="1" step="0.1" value="0.3" class="w-full">
            <div class="flex justify-end gap-2">
                <button onclick="saveWatermark(null)" class="px-4 py-2 text-red-500">清除</button>
                <button onclick="saveWatermark(true)" class="px-4 py-2 bg-brand text-white rounded">儲存</button>
            </div>
            <button onclick="toggleModal('watermarkModal')" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <!-- Loading & Toast -->
    <div id="loadingModal" class="fixed inset-0 bg-white/90 z-50 hidden flex flex-col items-center justify-center">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12 mb-4"></div>
        <p id="loadingText" class="text-slate-600 font-bold">處理中...</p>
    </div>
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 pointer-events-none z-[100] transition-opacity duration-300"></div>

    <script>
        // --- Global State (Flat & Simple) ---
        let fileStore = {}; // { id: { type: 'pdf'|'image', name, data, pdfDoc } }
        let fileManifest = []; // [docId1, docId2...] for Reset
        let pages = [];     // { id, fileId, pageIndex, rotation, type }
        let selectedIds = new Set();
        let clipboard = [];
        let history = [];
        let historyIndex = -1;
        
        // Config
        let metaConfig = null;
        let wmConfig = null;
        let pgNumConfig = null;
        let sortableInstance = null;
        let fileName = "merged_document";
        let exportDropdownOpen = false; // 新增：导出下拉菜单状态

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
            
            // 拖放功能
            const dropOverlay = document.getElementById('dropOverlay');
            let dragCounter = 0;
            const isFile = e => e.dataTransfer.types && Array.from(e.dataTransfer.types).includes('Files');

            window.addEventListener('dragenter', e => {
                if(isFile(e)) { e.preventDefault(); dragCounter++; dropOverlay.classList.remove('hidden'); setTimeout(()=>dropOverlay.classList.remove('opacity-0'),10); }
            });
            window.addEventListener('dragleave', e => {
                if(isFile(e)) { e.preventDefault(); dragCounter--; if(dragCounter===0) { dropOverlay.classList.add('opacity-0'); setTimeout(()=>dropOverlay.classList.add('hidden'),200); } }
            });
            window.addEventListener('dragover', e => { if(isFile(e)) e.preventDefault(); });
            window.addEventListener('drop', e => {
                if(isFile(e)) {
                    e.preventDefault(); dragCounter=0; dropOverlay.classList.add('opacity-0');
                    setTimeout(()=>dropOverlay.classList.add('hidden'),200);
                    handleFiles(e.dataTransfer.files);
                }
            });

            // 全局点击事件：点击其他地方关闭导出下拉菜单
            document.addEventListener('click', (e) => {
                const exportGroup = document.getElementById('exportBtnGroup');
                if (exportGroup && !exportGroup.contains(e.target)) {
                    toggleExportDropdown(false);
                }
            });

            document.addEventListener('keydown', handleKeys);
            document.getElementById('gridWrapper').addEventListener('click', (e) => { 
                if(e.target.id==='gridWrapper' || e.target.id==='gridContainer') deselectAll(); 
            });
        });

        // --- 导出下拉菜单控制 ---
        function toggleExportDropdown(show) {
            const dropdown = document.getElementById('exportDropdown');
            if (show === undefined) {
                exportDropdownOpen = !exportDropdownOpen;
            } else {
                exportDropdownOpen = show;
            }
            
            if (exportDropdownOpen) {
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // --- Core File Handling ---
        async function handleFiles(fileList) {
            if (!fileList.length) return;
            showLoading(true);
            
            try {
                recordHistory();
                
                for (let file of fileList) {
                    const docId = crypto.randomUUID();
                    const buffer = await file.arrayBuffer();
                    fileManifest.push(docId); // Track order

                    if (file.type === 'application/pdf') {
                        const pdfDoc = await pdfjsLib.getDocument({ data: buffer.slice(0) }).promise;
                        fileStore[docId] = { type: 'pdf', name: file.name, data: buffer, pdfDoc };
                        
                        for (let i = 0; i < pdfDoc.numPages; i++) {
                            pages.push({ id: crypto.randomUUID(), fileId: docId, pageIndex: i, rotation: 0, type: 'pdf' });
                        }
                    } else if (file.type.startsWith('image/')) {
                        fileStore[docId] = { type: 'image', name: file.name, data: buffer, mime: file.type };
                        pages.push({ id: crypto.randomUUID(), fileId: docId, pageIndex: 0, rotation: 0, type: 'image' });
                    }
                }

                if(fileList.length > 0 && fileName === 'merged_document') {
                     fileName = fileList[0].name.replace(/\.[^/.]+$/, "");
                     document.getElementById('fileNameInput').value = fileName;
                }

                renderGrid();
                updateUI();
                showToast("檔案已加入");
            } catch (e) {
                console.error(e);
                showToast("讀取失敗", true);
            } finally {
                showLoading(false);
            }
        }

        // --- The Real Reset Logic ---
        function resetPageOrder() {
            if (!fileManifest.length) return;
            if(confirm("確定重置為原始狀態？")) {
                recordHistory();
                pages = []; // Wipe current
                
                // Rebuild strictly from manifest
                for (let docId of fileManifest) {
                    const file = fileStore[docId];
                    if(!file) continue;

                    if(file.type === 'pdf') {
                        for(let i=0; i<file.pdfDoc.numPages; i++) {
                            pages.push({ id: crypto.randomUUID(), fileId: docId, pageIndex: i, rotation: 0, type: 'pdf' });
                        }
                    } else if (file.type === 'image') {
                         pages.push({ id: crypto.randomUUID(), fileId: docId, pageIndex: 0, rotation: 0, type: 'image' });
                    }
                }
                selectedIds.clear();
                renderGrid();
                updateUI();
                showToast("已重置");
            }
        }

        // --- Export Engine 2.0 ---
        async function exportFile(format) {
            if (pages.length === 0) return;
            showLoading(true, "處理中...");
            
            try {
                const { PDFDocument, degrees, PageSizes, StandardFonts, rgb } = PDFLib;

                if (format === 'pdf') {
                    const doc = await PDFDocument.create();
                    const cache = {}; // Reuse loaded pdf docs

                    // Meta & Fonts
                    if (metaConfig) {
                        if(metaConfig.title) doc.setTitle(metaConfig.title);
                        if(metaConfig.author) doc.setAuthor(metaConfig.author);
                    }
                    let font;
                    if(wmConfig || pgNumConfig) font = await doc.embedFont(StandardFonts.Helvetica);

                    for (let i=0; i<pages.length; i++) {
                        const p = pages[i];
                        let page;

                        if (p.type === 'blank') {
                            page = doc.addPage(PageSizes.A4);
                        } else {
                            const file = fileStore[p.fileId];
                            if (!file) continue;

                            if (p.type === 'pdf') {
                                if (!cache[p.fileId]) cache[p.fileId] = await PDFDocument.load(file.data);
                                const src = cache[p.fileId];
                                const [cp] = await doc.copyPages(src, [p.pageIndex]);
                                cp.setRotation(degrees(cp.getRotation().angle + p.rotation));
                                page = doc.addPage(cp);
                            } else if (p.type === 'image') {
                                if (!cache[p.fileId]) {
                                    if (file.mime.includes('png')) cache[p.fileId] = await doc.embedPng(file.data);
                                    else cache[p.fileId] = await doc.embedJpg(file.data);
                                }
                                const img = cache[p.fileId];
                                const dims = img.scale(1);
                                page = doc.addPage(PageSizes.A4);
                                const { width, height } = page.getSize();
                                const s = Math.min((width-40)/dims.width, (height-40)/dims.height, 1);
                                page.drawImage(img, {
                                    x: (width - dims.width*s)/2, y: (height - dims.height*s)/2,
                                    width: dims.width*s, height: dims.height*s,
                                    rotate: degrees(p.rotation)
                                });
                            }
                        }

                        // Overlays
                        if (wmConfig && page) {
                            const { width, height } = page.getSize();
                            page.drawText(wmConfig.text, {
                                x: width/2 - 50, y: height/2, size: 50,
                                color: rgb(1,0,0), opacity: wmConfig.opacity, rotate: degrees(45), font
                            });
                        }
                        if (pgNumConfig && page) {
                            const txt = `${pgNumConfig.start + i}`;
                            const { width } = page.getSize();
                            let x=30;
                            if(pgNumConfig.pos === 'bottom-center') x=width/2;
                            if(pgNumConfig.pos === 'bottom-right') x=width-40;
                            page.drawText(txt, { x, y: 30, size: 12, font, color: rgb(0,0,0) });
                        }
                    }

                    const out = await doc.save();
                    download(out, 'organized.pdf', 'application/pdf');
                
                } else {
                    // ZIP / IMG
                    const zip = new JSZip();
                    const cache = {};

                    for (let i=0; i<pages.length; i++) {
                        const p = pages[i];
                        const num = i+1;

                        // Image Export (Canvas Rendering)
                        if (format === 'images') {
                             const file = fileStore[p.fileId];
                             if (!file) continue;
                             
                             let blobData;
                             
                             if (p.type === 'image' && p.rotation === 0) {
                                 // Optimize: If image is not rotated, save raw file
                                 blobData = new Blob([file.data], {type: file.mime});
                             } else {
                                 // Render to canvas (PDF page or Rotated Image)
                                 const cvs = document.createElement('canvas');
                                 if (p.type === 'pdf') {
                                     const page = await file.pdfDoc.getPage(p.pageIndex + 1);
                                     const vp = page.getViewport({ scale: 2.0, rotation: p.rotation });
                                     cvs.width = vp.width; cvs.height = vp.height;
                                     await page.render({ canvasContext: cvs.getContext('2d'), viewport: vp }).promise;
                                 } else {
                                     // Rotated Image
                                     const img = new Image();
                                     const b = new Blob([file.data], {type: file.mime});
                                     await new Promise(r => { img.onload=r; img.src=URL.createObjectURL(b); });
                                     // Swap dimensions if 90/270
                                     if (p.rotation % 180 !== 0) { cvs.width = img.height; cvs.height = img.width; }
                                     else { cvs.width = img.width; cvs.height = img.height; }
                                     const ctx = cvs.getContext('2d');
                                     ctx.translate(cvs.width/2, cvs.height/2);
                                     ctx.rotate(p.rotation * Math.PI / 180);
                                     ctx.drawImage(img, -img.width/2, -img.height/2);
                                 }
                                 // Convert canvas to blob
                                 blobData = await new Promise(resolve => cvs.toBlob(resolve, 'image/jpeg', 0.8));
                             }
                             
                             if (blobData) zip.file(`page_${num}.jpg`, blobData);
                             continue; 
                        }
                        
                        if (format === 'text') {
                             if(p.type === 'pdf') {
                                 const file = fileStore[p.fileId];
                                 const page = await file.pdfDoc.getPage(p.pageIndex + 1);
                                 const content = await page.getTextContent();
                                 const str = content.items.map(item => item.str).join(' ');
                                 zip.file(`page_${num}.txt`, str);
                             }
                             continue;
                        }

                        // ZIP of PDFs
                        const sub = await PDFDocument.create();
                        if (p.type === 'blank') sub.addPage(PageSizes.A4);
                        else {
                             const file = fileStore[p.fileId];
                             if (p.type === 'pdf') {
                                 if(!cache[p.fileId]) cache[p.fileId] = await PDFDocument.load(file.data);
                                 const [cp] = await sub.copyPages(cache[p.fileId], [p.pageIndex]);
                                 cp.setRotation(degrees(cp.getRotation().angle + p.rotation));
                                 sub.addPage(cp);
                             } else {
                                 // Image to PDF page
                                 if(!cache[p.fileId]) cache[p.fileId] = file.mime.includes('png') ? await sub.embedPng(file.data) : await sub.embedJpg(file.data);
                                 const img = cache[p.fileId];
                                 const page = sub.addPage(PageSizes.A4);
                                 const {width, height} = page.getSize();
                                 const dims = img.scale(1);
                                 const s = Math.min((width-40)/dims.width, (height-40)/dims.height, 1);
                                 page.drawImage(img, { x: (width-dims.width*s)/2, y: (height-dims.height*s)/2, width: dims.width*s, height: dims.height*s, rotate: degrees(p.rotation) });
                             }
                        }
                        const b = await sub.save();
                        zip.file(`page_${num}.pdf`, b);
                    }
                    const content = await zip.generateAsync({type:"blob"});
                    download(content, 'pages.zip', 'application/zip');
                }
                
                showToast("完成");
            } catch(e) {
                console.error(e);
                showToast("導出錯誤", true);
            } finally {
                showLoading(false);
            }
        }

        function download(data, name, type) {
            const b = new Blob([data], {type});
            const url = URL.createObjectURL(b);
            const a = document.createElement('a'); a.href=url; a.download=name; 
            document.body.appendChild(a); // Firefox requires body append
            a.click(); 
            document.body.removeChild(a);
        }

        // --- Common UI & Logic ---
        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            
            pages.forEach((p, i) => {
                const el = document.createElement('div');
                const isSel = selectedIds.has(p.id);
                el.className = `page-card bg-white dark:bg-darkCard rounded-xl p-2 cursor-pointer relative group border-2 ${isSel ? 'border-brand ring-2 ring-brand/20' : 'border-transparent hover:border-indigo-200'}`;
                el.dataset.id = p.id;
                el.onclick = (e) => toggleSelect(p.id, e.ctrlKey || e.metaKey);
                
                let badgeColor = p.type==='pdf' ? 'bg-red-100 text-red-600' : p.type==='image' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600';
                
                el.innerHTML = `
                    <div class="relative aspect-[1/1.4] bg-slate-100 rounded mb-2 overflow-hidden flex items-center justify-center">
                        <div class="w-full h-full transition-transform flex items-center justify-center" style="transform: rotate(${p.rotation}deg)">
                            <canvas id="cvs-${p.id}" class="max-w-full max-h-full object-contain"></canvas>
                        </div>
                        <div class="absolute top-1 left-1 w-5 h-5 rounded-full ${isSel ? 'bg-brand' : 'bg-black/20'} flex items-center justify-center text-white text-xs">
                            <i class="fa-solid fa-check ${isSel ? '' : 'opacity-0'}"></i>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-[10px] font-bold text-slate-500">
                        <span>Pg ${i+1}</span>
                        <span class="${badgeColor} px-1 rounded uppercase">${p.type}</span>
                    </div>
                `;
                
                container.appendChild(el);
                
                // Lazy Render
                setTimeout(() => renderThumbnail(p), 0);
            });

            if(sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(container, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: (evt) => {
                    recordHistory();
                    const item = pages.splice(evt.oldIndex, 1)[0];
                    pages.splice(evt.newIndex, 0, item);
                    renderGrid(); // re-render to update indices
                }
            });
        }

        async function renderThumbnail(p) {
            const cvs = document.getElementById(`cvs-${p.id}`);
            if (!cvs || p.type === 'blank') return;
            
            const file = fileStore[p.fileId];
            if (!file) return;

            if (p.type === 'pdf') {
                try {
                    const page = await file.pdfDoc.getPage(p.pageIndex + 1);
                    const viewport = page.getViewport({ scale: 0.3 });
                    cvs.width = viewport.width;
                    cvs.height = viewport.height;
                    await page.render({ canvasContext: cvs.getContext('2d'), viewport: viewport }).promise;
                } catch(e) {}
            } else if (p.type === 'image') {
                const img = new Image();
                const blob = new Blob([file.data], {type: file.mime});
                img.src = URL.createObjectURL(blob);
                img.onload = () => {
                    const scale = Math.min(300/img.width, 300/img.height);
                    cvs.width = img.width * scale;
                    cvs.height = img.height * scale;
                    cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                };
            }
        }

        // Actions
        function toggleSelect(id, multi) {
            if (!multi) selectedIds.clear();
            if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id);
            renderGrid(); updateUI();
        }
        function selectAll() { pages.forEach(p => selectedIds.add(p.id)); renderGrid(); updateUI(); }
        function deselectAll() { selectedIds.clear(); renderGrid(); updateUI(); }
        function rotateAll(angle) { if (!pages.length) return; recordHistory(); pages.forEach(p => p.rotation = (p.rotation + angle) % 360); renderGrid(); }
        function rotateSelected(angle) { if (!selectedIds.size) return; recordHistory(); pages.forEach(p => { if(selectedIds.has(p.id)) p.rotation = (p.rotation + angle) % 360; }); renderGrid(); }
        function deleteSelected() { if (!selectedIds.size) return; recordHistory(); pages = pages.filter(p => !selectedIds.has(p.id)); selectedIds.clear(); renderGrid(); updateUI(); }
        function addBlankPage() { recordHistory(); pages.push({ id: crypto.randomUUID(), type: 'blank', rotation: 0 }); renderGrid(); updateUI(); }
        function copySelected() { if (!selectedIds.size) return; clipboard = pages.filter(p => selectedIds.has(p.id)).map(p => ({...p})); updateUI(); showToast("已複製"); }
        function pastePages() { if (!clipboard.length) return; recordHistory(); const newItems = clipboard.map(p => ({...p, id: crypto.randomUUID()})); pages.push(...newItems); renderGrid(); updateUI(); showToast("已貼上"); }
        function reverseOrder() { recordHistory(); pages.reverse(); renderGrid(); }
        function closeAllFiles() { if(confirm("關閉所有文件？")) { pages=[]; fileStore={}; fileManifest=[]; selectedIds.clear(); history=[]; renderGrid(); updateUI(); } }

        function recordHistory() {
            if(historyIndex < history.length-1) history = history.slice(0, historyIndex+1);
            history.push(JSON.parse(JSON.stringify(pages)));
            if(history.length > 20) history.shift(); else historyIndex++;
            updateUndoRedoButtons();
        }
        function undo() { if(historyIndex >= 0) { pages = history[historyIndex]; historyIndex--; renderGrid(); updateUI(); } }
        function redo() { if(historyIndex < history.length - 1) { historyIndex++; pages = history[historyIndex]; renderGrid(); updateUI(); } }
        function updateUndoRedoButtons() { 
            document.getElementById('btnUndo').disabled = historyIndex < 0; 
            document.getElementById('btnRedo').disabled = historyIndex >= history.length - 1; 
        }

        function updateUI() {
            const hasPages = pages.length > 0;
            const empty = document.getElementById('emptyState');
            const main = document.getElementById('topBar');
            const grid = document.getElementById('gridWrapper');
            const info = document.getElementById('fileInfo');
            const addBtn = document.getElementById('addFileBtn');
            const addLabel = document.getElementById('addFileLabel');
            const exportGrp = document.getElementById('exportBtnGroup');
            const settGrp = document.getElementById('settingsBtnGroup');
            const title = document.getElementById('appTitle');

            if (hasPages) {
                empty.style.display = 'none';
                main.classList.remove('hidden');
                grid.classList.remove('hidden');
                info.classList.remove('hidden');
                info.classList.add('flex');
                addLabel.innerText = "新增檔案";
                exportGrp.classList.remove('hidden');
                settGrp.classList.remove('hidden');
                title.classList.add('hidden');
                document.getElementById('pageCountDisplay').innerText = `${pages.length} 頁`;
            } else {
                empty.style.display = 'flex';
                main.classList.add('hidden');
                grid.classList.add('hidden');
                info.classList.add('hidden');
                info.classList.remove('flex');
                addLabel.innerText = "開啟 PDF";
                exportGrp.classList.add('hidden');
                settGrp.classList.add('hidden');
                title.classList.remove('hidden');
            }
            document.getElementById('selectionBadge').innerText = `${selectedIds.size} 選取`;
            document.getElementById('statusBadges').innerText = `${selectedIds.size} 選取`;
        }

        function handleKeys(e) {
            if (document.getElementById('gridWrapper').classList.contains('hidden')) return;
            if (e.target.tagName === 'INPUT') return;
            const isCmd = e.ctrlKey || e.metaKey;
            if (isCmd && e.key === 'z') { e.preventDefault(); undo(); }
            if (isCmd && e.key === 'y') { e.preventDefault(); redo(); }
            if (isCmd && e.key === 'a') { e.preventDefault(); selectAll(); }
            if (isCmd && e.key === 'c') { e.preventDefault(); copySelected(); }
            if (isCmd && e.key === 'v') { e.preventDefault(); pastePages(); }
            if (e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); deleteSelected(); }
        }

        function showLoading(s, t) { 
            document.getElementById('loadingModal').classList.toggle('hidden', !s); 
            if (t) document.getElementById('loadingText').textContent = t;
        }
        function showToast(m, err) { 
            const t = document.getElementById('toast'); 
            t.innerText = m; 
            t.classList.remove('translate-y-4','opacity-0'); 
            if(err) t.classList.add('bg-red-600'); else t.classList.remove('bg-red-600');
            setTimeout(()=>t.classList.add('translate-y-4','opacity-0'), 2000);
        }
        function updateZoom(v) { 
            const size = parseInt(v);
            document.getElementById('gridContainer').style.gridTemplateColumns = `repeat(auto-fill, minmax(${size}px, 1fr))`; 
        }
        function toggleModal(id) { 
            const el = document.getElementById(id); 
            el.classList.toggle('hidden'); 
        }
        function toggleDarkMode() { 
            document.documentElement.classList.toggle('dark'); 
        }
        function handleBackgroundClick(e) { 
            if(e.target.id==='gridWrapper'||e.target.id==='gridContainer') deselectAll(); 
        }

        // --- Settings (Simplified) ---
        function setPagePos(p) { 
            document.querySelectorAll('.pn-btn').forEach(b => {
                 if(b.dataset.pos===p) {
                     b.classList.add('bg-indigo-50','border-indigo-500','text-indigo-600');
                 } else {
                     b.classList.remove('bg-indigo-50','border-indigo-500','text-indigo-600');
                 }
            });
        }
        function setPageSettings(save) {
            if(save) {
                const active = document.querySelector('.pn-btn.bg-indigo-50');
                pgNumConfig = {
                    pos: active ? active.dataset.pos : 'bottom-center',
                    start: parseInt(document.getElementById('pnStart').value) || 1,
                    size: 12 // Fixed: pnSize element doesn't exist
                };
                showToast("頁碼已設定");
            } else { 
                pgNumConfig = null; 
                showToast("頁碼已移除"); 
            }
            toggleModal('pageNumberModal');
        }
        function saveMeta() {
            metaConfig = {
                title: document.getElementById('metaTitle').value,
                author: document.getElementById('metaAuthor').value
            };
            toggleModal('metadataModal');
            showToast("元數據已設定");
        }
        function saveWatermark(save) {
            if(save) {
                wmConfig = {
                    text: document.getElementById('wmText').value,
                    color: document.getElementById('wmColor').value,
                    opacity: parseFloat(document.getElementById('wmOpacity').value)
                };
                if(!wmConfig.text) { wmConfig=null; }
                showToast("浮水印已設定");
            } else { 
                wmConfig = null; 
                showToast("浮水印已移除"); 
            }
            toggleModal('watermarkModal');
        }
    </script>
</body>
</html>
